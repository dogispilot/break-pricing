<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Skunksniper.com</title>
  <!-- Include Chart.js library -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Load custom fonts */
    @font-face {
      font-family: 'BreakPricingFont';
      src: url('fonts/breakpricingfont.ttf') format('truetype');
    }
    @font-face {
      font-family: 'BreakPricingFontBold';
      src: url('fonts/breakpricingfont_bold.ttf') format('truetype');
    }

    body {
      font-family: 'BreakPricingFont', sans-serif;
      margin: 20px;
      background: #f9f9f9;
      color: #333;
    }
    h1, h2 {
      font-family: 'BreakPricingFontBold', sans-serif;
    }

    header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    header img {
      width: 50px;
      height: 50px;
      margin-right: 10px;
    }
    header h1 {
      margin: 0;
      font-size: 2em;
    }
    header a {
      margin-left: auto;
      text-decoration: none;
      color: #333;
      font-weight: bold;
      font-size: 1em;
    }
    header p {
      font-style: italic;
      margin: 0 0 0 60px;
      color: #666;
    }

    section {
      background: #fff;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    /* Container for all tiles */
    .tile-container {
      margin-top: 10px;
    }

    /* Set Details tiles */
    .tile {
      background: #eaeaea;
      border-radius: 4px;
      text-align: center;
      padding: 10px;
    }
    .tile-value {
      font-family: 'BreakPricingFontBold', sans-serif;
      font-size: 2em;
      margin-bottom: 5px;
    }
    .tile-desc {
      font-size: 1em;
    }

    /* Hero and Support rows */
    .hero-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .hero-row .tile {
      flex: 0 0 calc(50% - 10px);
      box-sizing: border-box;
    }
    .support-row {
      display: flex;
      gap: 10px;
    }
    .support-row .tile {
      flex: 0 0 calc(25% - 10px);
      box-sizing: border-box;
    }

    /* Updated styling for set selection inputs and sentence */
    #set-selection p {
      font-size: 1.5em;
      font-weight: 900;
      color: #1a1a1a;
    }
    #set-selection select {
      width: auto; /* Let it size automatically by default. */
      display: inline-block;
      font-family: 'BreakPricingFont', sans-serif;
      font-weight: 900;
      color: #1a1a1a;
      text-decoration: underline;
      background: transparent;
      border: none;
      padding: 0;
      margin: 0 5px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      font-size: inherit;
    }

    /* Hide set notes by default */
    #set-notes {
      display: none;
      padding: 10px;
      border: 1px dashed #aaa;
      margin-top: 5px;
    }

    /* Break Controls Layout */
    .break-controls-container {
      position: relative;
    }
    .break-controls {
      margin-bottom: 20px;
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }
    .input-group {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .input-group label {
      margin-bottom: 3px;
      font-weight: bold;
      font-size: 0.8em;
      text-align: left;
    }

    /* For groups that are in a price-setting context */
    .price-setting-group {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-bottom: 0px;
    }
    .price-setting-group label {
      margin-bottom: 3px;
      font-weight: bold;
      font-size: 0.8em;
    }

    /* Input-inline container to align input fields horizontally */
    .input-inline {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    /* Input-wrapper for fields with prefix/suffix */
    .input-wrapper {
      display: inline-flex;
      align-items: center;
      height: 36px;
      border: 1px solid #ccc;
      border-radius: 6px;
      overflow: hidden;
      background: #fff;
    }
    .input-wrapper input[type="number"] {
      border: none;
      outline: none;
      text-align: center;
      height: 100%;
      width: 100%;
      padding: 0;
      font-size: 1em;
      font-family: inherit;
    }
    .input-wrapper .input-prefix,
    .input-wrapper .input-suffix {
      padding: 0 8px;
      background-color: #eee;
      font-size: 1em;
      font-family: inherit;
      color: #333;
      white-space: nowrap;
    }

    /* Modern input styling for number inputs */
    input[type="number"] {
      height: 36px !important;
      line-height: 36px !important;
      font-size: 1em;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 0 8px;
      font-family: 'BreakPricingFont', sans-serif;
    }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }

    /* Existing boost/discount inputs override */
    .boost-input {
      width: 60px;
    }

    /* Button group inline for Price Settings/Lookup buttons */
    .button-group-inline {
      display: inline-flex;
      gap: 10px;
      align-items: center;
      font-family: 'BreakPricingFont', sans-serif;
    }

    /* eBay and NHL buttons */
    .ebay-btn {
      background: none !important;
      padding: 0 !important;
      border: none !important;
      display: flex !important;
      justify-content: flex-start;
      text-decoration: none !important;
      max-width: 75%;
      height: auto;
    }
    .nhl-btn {
      background: none !important;
      padding: 0 !important;
      border: none !important;
      display: flex !important;
      justify-content: flex-end;
      text-decoration: none !important;
      max-width: 75%;
      height: auto;
    }
    .ebay-btn img, .nhl-btn img {
      max-width: 75%;
      height: auto;
      box-shadow: none !important;
    }

    /* eBay button used in the team table */
    .table-ebay-btn {
      background: none !important;
      padding: 0 !important;
      border: none !important;
      display: inline-block;
      width: auto; 
    }
    .table-ebay-btn img {
      max-height: 25px;
      width: auto;
      vertical-align: middle;
      box-shadow: 0 2px 2px rgba(0, 0, 0, 0.15);
      border-radius: 90px; /* optional, for rounded corners */
    }

    /* Table styling */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 8px;
      text-align: center;
      vertical-align: middle;
    }

    /* Make the first column left aligned */
    #team-table th:first-child,
    #team-table td:first-child {
      text-align: left;
    }
    /* Table header (Boost column) */
    #team-table th:nth-child(6) {
      width: 150px;
    }

    /* Lookup buttons */
    .lookup-button {
      padding: 8px 12px;
      font-size: 0.9rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #fff;
      color: #333;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-width: 150px;
      box-sizing: border-box;
      font-family: 'BreakPricingFont', sans-serif;
    }
    .lookup-button img {
      width: 24px;
      height: 24px;
      vertical-align: middle;
    }

    /* Glow effects on hover */
    .glow-dacardworld:hover,
    .glow-steelcity:hover,
    .glow-outofthebox:hover,
    .glow-midwestcards:hover,
    .glow-tcdb:hover,
    .glow-hockeychecklists:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      transform: scale(1.05);
    }

    /* Price Settings and Price Lookup buttons */
    #priceSettingsToggle,
    #priceLookupToggle {
      background-color: transparent;
      color: #333;
      border: 1px solid #333;
      border-radius: 20px;
      padding: 2px 10px;
      cursor: pointer;
      font-size: 0.8em;
      height: 24px;
      font-family: 'BreakPricingFont', sans-serif;
    }

    /* Price Settings and Price Lookup menus ‚Äì positioned absolutely below the break controls */
    #price-settings, #price-lookup-menu {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      gap: 15px;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      padding: 10px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-family: 'BreakPricingFont', sans-serif;
      z-index: 10;
    }

    /* Button Container inside Price Lookup Menu remains unchanged */
    .button-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* Set Details button container */
    #set-details .button-container {
      justify-content: flex-start;
      margin-bottom: 20px;
    }

    /* Break Sniffer Right Column */
    .break-results-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }
    /* Break Sniffer results layout */
    #break-results {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    #break-tiles .tile {
      margin: 5px;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
    }

    /* Pie Chart canvas */
    #pieChart {
      display: block;
    }

    /* Combined Boost/Discount iOS Toggle styling */
    .ios-toggle {
      display: inline-flex;
      align-items: center;
      position: relative;
      width: 60px;
      height: 30px;
      border-radius: 15px;
      background-color: grey;
      cursor: pointer;
      transition: background-color 0.4s;
    }
    .ios-toggle input {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }
    .ios-toggle .toggle-slider {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-color: white;
      transition: transform 0.4s;
    }
    /* Move the slider if checked */
    .ios-toggle input:checked + .toggle-slider {
      transform: translateX(30px);
    }

    .ios-toggle .toggle-label {
      font-size: 16px;
      z-index: 1;
      user-select: none;
    }
    .ios-toggle .toggle-rocket {
      margin-left: 5px;
      margin-right: auto;
    }
    .ios-toggle .toggle-scissors {
      margin-right: 5px;
      margin-left: auto;
    }

    /* Keep toggle + input on same line */
    .boost-toggle-container {
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    /* Key Rookies section */
    #rookie-tiles {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    #rookie-tiles .tile {
      flex: 0 0 calc(33% - 10px);
      box-sizing: border-box;
      padding: 10px;
    }
    .rookie-img {
      max-width: 50%;
      height: auto;
      display: block;
      margin: 0;
      position: relative;
      z-index: 2;
    }
    .team-img {
      max-width: 50%;
      height: auto;
      object-fit: contain;
      margin-right: -60px;
      vertical-align: middle;
      opacity: 0.7;
      position: relative;
      z-index: 1;
    }
    .key-rookie-logo { }
    .rookie-notes {
      font-size: 0.9em;
      color: #555;
      margin-bottom: 5px;
    }
    .rookie-image-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0px;
    }

    /* Row highlight for key rookie teams */
    .key-rookie-row {
      background-color: #fffeb3; /* A soft yellow highlight */
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <img src="resources/skunk.png" alt="Skunk logo">
    <h1>Skunksniper.com</h1>
    <a href="about.html">About</a>
  </header>
  <p>Sniff out the best breaks</p>

  <!-- Section 1: Set and Year Selection -->
  <section id="set-selection">
    <p>
      I want to explore 
      <select id="setNameSelect">
        <option value="">-- Select Set Name --</option>
      </select>
      for the years 
      <select id="setYearSelect">
        <!-- Populated by config.json -->
      </select>
    </p>
  </section>

  <!-- Section 2: Set Details -->
  <section id="set-details">
    <h2>üìù Set Details</h2>
    <div class="button-container">
      <button type="button" class="lookup-button glow-tcdb" onclick="openTcdbSearch()">
        <img src="resources/tcdb.jpg" alt="TCDB Logo"> TCDB
      </button>
      <button type="button" class="lookup-button glow-hockeychecklists" onclick="openHockeyChecklistsSearch()">
        <img src="resources/hockeychecklists.png" alt="HockeyChecklists Logo"> HockeyChecklists.com
      </button>
    </div>
    <div id="details-text"></div>
    <a href="#" id="toggleNotes" style="text-decoration:underline;">Read Set Notes</a>
    <div id="set-notes"></div>
    <div class="tile-container" id="set-tiles">
      <!-- Hero and support rows are inserted here -->
    </div>
  </section>

  <!-- Section 3: Key Rookies -->
  <section id="key-rookies">
    <h2>üîë Key Rookies</h2>
    <div class="tile-container" id="rookie-tiles">
      <!-- Key rookie tiles appear here -->
    </div>
  </section>

  <!-- Section 4: Break Sniffer -->
  <section id="break-sniffer">
    <h2>üëÉ Break Sniffer</h2>
    <div class="break-sniffer-flex">
      <!-- Left Column: Controls -->
      <div class="break-controls-container">
        <div class="break-controls" id="break-controls-row">
          <!-- Cost of a case -->
          <div class="input-group">
            <label for="caseCost">Cost of a case</label>
            <div class="input-inline">
              <div class="input-wrapper" style="width:120px;">
                <span class="input-prefix">$</span>
                <input type="number" id="caseCost" step="0.01" value="1999.95">
              </div>
            </div>
          </div>
          <!-- Markup group -->
          <div class="input-group price-setting-group">
            <label for="markupValue">Markup</label>
            <div class="input-inline">
              <div class="input-wrapper" style="width:120px;">
                <span class="input-prefix markup-prefix" style="display: none;">$</span>
                <input type="number" id="markupValue" step="0.01" value="500">
                <span class="input-suffix markup-suffix" style="display: none;">%</span>
              </div>
              <div class="button-group-inline">
                <button id="priceSettingsToggle" type="button">Price Settings</button>
                <button id="priceLookupToggle" type="button">Price Lookup</button>
              </div>
            </div>
          </div>
        </div>
        <!-- Price Settings Menu -->
        <div id="price-settings">
          <div class="price-setting-group">
            <label for="markupToggle">Use % markup</label>
            <label class="toggle-switch">
              <input type="checkbox" id="markupToggle">
              <span class="slider"></span>
            </label>
          </div>
          <div class="price-setting-group">
            <label for="suppliesCost">Supplies per team</label>
            <div class="input-wrapper" style="width:80px;">
              <span class="input-prefix">$</span>
              <input type="number" id="suppliesCost" step="0.01" value="1.00">
            </div>
          </div>
          <div class="price-setting-group">
            <label for="blendedTax">Blended tax</label>
            <div class="input-wrapper" style="width:80px;">
              <input type="number" id="blendedTax" step="0.1" value="5.1">
              <span class="input-suffix">%</span>
            </div>
          </div>
        </div>
        <!-- Price Lookup Menu -->
        <div id="price-lookup-menu">
          <div class="button-container">
            <button type="button" class="lookup-button glow-dacardworld" onclick="openDacardworldSearch()">
              <img src="resources/dacardworld.png" alt="Dacardworld Logo">
              Dacardworld.com
            </button>
            <button type="button" class="lookup-button glow-steelcity" onclick="openSteelCitySearch()">
              <img src="https://www.steelcitycollectibles.com/storage/img/logo-scc.svg" alt="Steel City Logo">
              SteelCityCollectibles.com
            </button>
            <button type="button" class="lookup-button glow-outofthebox" onclick="openOotbSearch()">
              <img src="resources/ootb.png" alt="Out of the Box Logo">
              Out of the Box
            </button>
            <button type="button" class="lookup-button glow-midwestcards" onclick="openMidwestCardsSearch()">
              <img src="resources/midwestcards.png" alt="Midwest Cards Logo">
              Midwest Cards
            </button>
          </div>
        </div>
      </div>
      <!-- Right Column: Break Sniffer Results -->
      <div class="break-results-container">
        <div id="break-results">
          <div class="tiles" id="break-tiles">
            <!-- Breaker boxes appear here -->
          </div>
          <!-- Pie Chart -->
          <canvas id="pieChart" width="250" height="250"></canvas>
        </div>
      </div>
    </div>

    <!-- Table for Break Sniffer Results -->
    <table id="team-table">
      <thead>
        <tr>
          <th>Team</th>
          <th>Numbered Cards</th>
          <th>Distribution</th>
          <th>Avg. Cards per Case</th>
          <th>Cost + Markup</th>
          <th>Boost</th>
          <th>Team Price</th>
        </tr>
      </thead>
      <tbody>
        <!-- Table rows are dynamically generated here -->
      </tbody>
    </table>
  </section>

  <!-- Hidden span used to measure text width of the selected option -->
  <span id="hiddenSelectText" style="visibility: hidden; position: absolute; white-space: nowrap;"></span>

  <script>
    // Sizing for the select elements
    function updateSelectWidth(selectElement) {
      const selectedText = selectElement.options[selectElement.selectedIndex].text;
      const hiddenSpan = document.getElementById('hiddenSelectText');
      const computedStyles = window.getComputedStyle(selectElement);

      // Match the select's font style so measurement is accurate
      hiddenSpan.style.fontSize = computedStyles.fontSize;
      hiddenSpan.style.fontWeight = computedStyles.fontWeight;
      hiddenSpan.style.fontFamily = computedStyles.fontFamily;
      hiddenSpan.style.textDecoration = computedStyles.textDecoration;

      hiddenSpan.textContent = selectedText;
      const textWidth = hiddenSpan.getBoundingClientRect().width;
      // Add a small padding to avoid cutting off arrows, etc.
      selectElement.style.width = (textWidth + 10) + "px";
    }

    function updateAllSelectWidths() {
      const nameSelect = document.getElementById('setNameSelect');
      const yearSelect = document.getElementById('setYearSelect');
      if (nameSelect) updateSelectWidth(nameSelect);
      if (yearSelect) updateSelectWidth(yearSelect);
    }

    // Toggle markup prefix vs suffix
    function updateMarkupUnit() {
      const isPercent = document.getElementById('markupToggle').checked;
      const prefix = document.querySelector('.markup-prefix');
      const suffix = document.querySelector('.markup-suffix');
      if (isPercent) {
        prefix.style.display = 'none';
        suffix.style.display = 'inline';
      } else {
        prefix.style.display = 'inline';
        suffix.style.display = 'none';
      }
    }

    let config = null;
    let currentSet = null;
    let pieChartInstance = null;
    let breakSnifferTimeout;

    function debouncedUpdateBreakSniffer() {
      clearTimeout(breakSnifferTimeout);
      breakSnifferTimeout = setTimeout(() => {
        updateBreakSniffer();
      }, 300);
    }

    // The toggle background color is determined by the final logic in updateBreakSniffer(),
    // so here we simply recalc after any user change (input or toggle).
    function updateToggleBackground(team) {
      debouncedUpdateBreakSniffer();
    }

    // Load config, set up event listeners
    async function loadConfig() {
      try {
        const response = await fetch('config.json');
        config = await response.json();
        populateYearDropdown();
        updateSetNameDropdown();
        // We will still call it here...
        updateAllSelectWidths();

        // Listen for changes in the break controls
        document.querySelectorAll('#break-controls-row input, #price-settings input')
          .forEach(input => {
            input.addEventListener('input', debouncedUpdateBreakSniffer);
          });

        // Listen for changes in the select elements
        document.getElementById('setNameSelect').addEventListener('change', function() {
          updateSelectWidth(this);
        });
        document.getElementById('setYearSelect').addEventListener('change', function() {
          updateSelectWidth(this);
        });

        // Markup toggle
        document.getElementById('markupToggle').addEventListener('change', updateMarkupUnit);
        updateMarkupUnit();

        // Price settings + lookup toggles
        document.getElementById('priceSettingsToggle').addEventListener('click', function() {
          const ps = document.getElementById('price-settings');
          ps.style.display = (ps.style.display === 'none' || ps.style.display === '') ? 'flex' : 'none';
        });
        document.getElementById('priceLookupToggle').addEventListener('click', function() {
          const pl = document.getElementById('price-lookup-menu');
          pl.style.display = (pl.style.display === 'none' || pl.style.display === '') ? 'flex' : 'none';
        });

        // Selection changes
        document.getElementById('setYearSelect').addEventListener('change', () => {
          updateSetNameDropdown();
          onSelectionChange();
        });
        document.getElementById('setNameSelect').addEventListener('change', onSelectionChange);

        // Show/hide notes
        document.getElementById('toggleNotes').addEventListener('click', function(e){
          e.preventDefault();
          const notesDiv = document.getElementById('set-notes');
          notesDiv.style.display = (notesDiv.style.display === 'none' || notesDiv.style.display === '') 
            ? 'block' : 'none';
        });

        onSelectionChange();
      } catch (error) {
        console.error("Error loading config.json:", error);
      }
    }

    // Ensure width adjustments after full page load (prevents extra space):
    window.addEventListener('load', () => {
      setTimeout(updateAllSelectWidths, 0);
    });

    // Populate the year dropdown
    function populateYearDropdown() {
      const setYearSelect = document.getElementById('setYearSelect');
      let years = new Set();
      config.sets.forEach(s => { years.add(s.year); });
      years = Array.from(years).sort();
      const defaultYear = years[years.length - 1];

      years.forEach(year => {
        const opt = document.createElement('option');
        opt.value = year;
        opt.textContent = year;
        if (year === defaultYear) {
          opt.selected = true;
        }
        setYearSelect.appendChild(opt);
      });
    }

    // When the year changes, update the set name dropdown
    function updateSetNameDropdown() {
      const year = document.getElementById('setYearSelect').value;
      const setNameSelect = document.getElementById('setNameSelect');
      const currentSelected = setNameSelect.value;
      setNameSelect.innerHTML = "";

      const defaultOpt = document.createElement('option');
      defaultOpt.value = "";
      defaultOpt.textContent = "-- Select Set Name --";
      setNameSelect.appendChild(defaultOpt);

      const filteredSets = config.sets.filter(s => s.year === year);
      const uniqueNames = [...new Set(filteredSets.map(s => s.name))].sort();

      let found = false;
      uniqueNames.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        if(name === currentSelected) {
          opt.selected = true; 
          found = true;
        }
        setNameSelect.appendChild(opt);
      });
      if (!found) {
        setNameSelect.value = "";
      }
      updateSelectWidth(setNameSelect);
    }

    // Fired whenever user changes the set name or year
    function onSelectionChange() {
      const setName = document.getElementById('setNameSelect').value;
      const setYear = document.getElementById('setYearSelect').value;
      currentSet = config.sets.find(s => s.name === setName && s.year === setYear);

      updateSetDetails();
      updateBreakCaseCost();
      updateKeyRookies();
      updateBreakSniffer();

      const toggleNotesLink = document.getElementById('toggleNotes');
      if (!currentSet) {
        toggleNotesLink.style.display = 'none';
        document.getElementById('details-text').textContent = "";
        document.getElementById('set-tiles').innerHTML = "";
        document.getElementById('team-table').querySelector('tbody').innerHTML = "";
      } else {
        toggleNotesLink.style.display = 'inline';
      }
    }

    function updateBreakCaseCost() {
      if (currentSet && currentSet.price) {
        const priceNum = parseFloat(currentSet.price.replace(/[^0-9.]/g, ''));
        if (!isNaN(priceNum)) { 
          document.getElementById('caseCost').value = priceNum.toFixed(2); 
        }
      }
    }

    // Fill in set details and notes
    function updateSetDetails() {
      const detailsDiv = document.getElementById('details-text');
      const notesDiv = document.getElementById('set-notes');
      const tilesDiv = document.getElementById('set-tiles');

      if (!currentSet) {
        detailsDiv.textContent = "";
        notesDiv.textContent = "";
        tilesDiv.innerHTML = "";
        return;
      }

      detailsDiv.textContent = 
        `${currentSet.year} ${currentSet.name} was released on ${currentSet.release_date}. ` +
        `The configuration is ${currentSet.configuration}.`;

      notesDiv.textContent = currentSet.notes || "No additional notes available.";
      tilesDiv.innerHTML = "";

      const heroContainer = document.createElement('div');
      heroContainer.className = 'hero-row';
      const supportContainer = document.createElement('div');
      supportContainer.className = 'support-row';

      // Example hero tile: Rookie %
      const heroTile1 = document.createElement('div');
      heroTile1.className = 'tile hero';
      heroTile1.innerHTML = `
        <div class="tile-value">${currentSet.rookie_percentage || "N/A"}</div>
        <div class="tile-desc">Rookie %</div>
      `;
      heroContainer.appendChild(heroTile1);

      // Example hero tile: Total cards per case
      const totalCardsPerCase = computeTotalCardsPerCase(currentSet);
      const heroTile2 = document.createElement('div');
      heroTile2.className = 'tile hero';
      heroTile2.innerHTML = `
        <div class="tile-value">${totalCardsPerCase || "N/A"}</div>
        <div class="tile-desc">Total Cards per Case</div>
      `;
      heroContainer.appendChild(heroTile2);

      // Support tiles
      const tileBoxes = document.createElement('div');
      tileBoxes.className = 'tile';
      tileBoxes.innerHTML = `
        <div class="tile-value">${currentSet.boxes_per_case || "N/A"}</div>
        <div class="tile-desc">Boxes per Case</div>
      `;
      supportContainer.appendChild(tileBoxes);

      const tilePacks = document.createElement('div');
      tilePacks.className = 'tile';
      tilePacks.innerHTML = `
        <div class="tile-value">${currentSet.packs_per_box || "N/A"}</div>
        <div class="tile-desc">Packs per Box</div>
      `;
      supportContainer.appendChild(tilePacks);

      const tileCardsPack = document.createElement('div');
      tileCardsPack.className = 'tile';
      tileCardsPack.innerHTML = `
        <div class="tile-value">${currentSet.cards_per_pack || "N/A"}</div>
        <div class="tile-desc">Cards per Pack</div>
      `;
      supportContainer.appendChild(tileCardsPack);

      const cardsPerBox = computeCardsPerBox(currentSet);
      const tileCardsBox = document.createElement('div');
      tileCardsBox.className = 'tile';
      tileCardsBox.innerHTML = `
        <div class="tile-value">${cardsPerBox || "N/A"}</div>
        <div class="tile-desc">Cards per Box</div>
      `;
      supportContainer.appendChild(tileCardsBox);

      // Put hero + support in the tiles container
      tilesDiv.appendChild(heroContainer);
      tilesDiv.appendChild(supportContainer);
    }

    function computeTotalCardsPerCase(setObj) {
      const boxes = parseFloat(setObj.boxes_per_case);
      const packs = parseFloat(setObj.packs_per_box);
      const cards = parseFloat(setObj.cards_per_pack);
      if (isNaN(boxes) || isNaN(packs) || isNaN(cards)) return null;
      return boxes * packs * cards;
    }
    function computeCardsPerBox(setObj) {
      const packs = parseFloat(setObj.packs_per_box);
      const cards = parseFloat(setObj.cards_per_pack);
      if (isNaN(packs) || isNaN(cards)) return null;
      return packs * cards;
    }

    // Populate key rookies
    function updateKeyRookies() {
      const rookieContainer = document.getElementById('rookie-tiles');
      rookieContainer.innerHTML = "";
      const selectedYear = document.getElementById('setYearSelect').value;
      const keyPlayers = config["Key Players"] || config.keyPlayers;

      if (keyPlayers && Array.isArray(keyPlayers)) {
        const keyRookies = keyPlayers.filter(player => {
          const teamKey = player.Team || player.team;
          return player.type 
            && player.type.toLowerCase() === 'rookie'
            && player.setYear === selectedYear
            && teamKey;
        });

        if (keyRookies.length > 0) {
          keyRookies.forEach(player => {
            const tile = document.createElement('div');
            tile.className = 'tile';

            const teamKey = player.Team || player.team;
            const teamImage = 
              config.images 
              && config.images["team images"] 
              && config.images["team images"][teamKey] 
                ? config.images["team images"][teamKey] 
                : "";

            tile.innerHTML = `
              <strong>${player.player}</strong>
              <div class="rookie-notes">${player.notes || ""}</div>
              <div class="rookie-image-container">
                ${
                  teamImage 
                  ? `<img class="team-img key-rookie-logo" src="${teamImage}" alt="${teamKey}">`
                  : ""
                }
                <img class="rookie-img" src="${player.image}" alt="${player.player}">
              </div>
            `;

            const btnContainer = document.createElement('div');
            btnContainer.style.display = "inline-flex";
            btnContainer.style.gap = "15px";
            btnContainer.style.marginTop = "8px";

            const nhlLink = document.createElement("a");
            nhlLink.href = player.profile_link;
            nhlLink.target = "_blank";
            nhlLink.className = "nhl-btn";
            nhlLink.innerHTML = '<img src="resources/nhl_button.png" alt="NHL Profile">';
            btnContainer.appendChild(nhlLink);

            const ebayLink = document.createElement("a");
            ebayLink.href = "javascript:void(0)";
            ebayLink.className = "ebay-btn";
            ebayLink.onclick = () => openPlayerEbaySearch(player.player);
            ebayLink.innerHTML = '<img src="resources/ebay_button.png" alt="eBay">';
            btnContainer.appendChild(ebayLink);

            tile.appendChild(btnContainer);
            rookieContainer.appendChild(tile);
          });
        } else {
          rookieContainer.textContent = "No key rookie players found for the selected year.";
        }
      } else {
        rookieContainer.textContent = "No key players data available.";
      }
    }

    // Recalculate and render the table rows
    function updateBreakSniffer() {
      if (!currentSet) {
        document.getElementById('break-tiles').textContent = 
          "Please select a set and year to get started.";
        document.getElementById('team-table').querySelector('tbody').innerHTML = "";
        return;
      }

      const costCase = parseFloat(document.getElementById('caseCost').value);
      const markupVal = parseFloat(document.getElementById('markupValue').value) || 0;
      const usePercent = document.getElementById('markupToggle').checked;
      const suppliesCost = parseFloat(document.getElementById('suppliesCost').value);
      const blendedTax = parseFloat(document.getElementById('blendedTax').value);

      // Markup logic
      let costWithMarkup = usePercent 
        ? costCase * (1 + markupVal / 100)
        : costCase + markupVal; 

      // 8% cut from the marketplace
      const whatnotsCut = costWithMarkup * 0.08;

      // Gather team data
      const teams = currentSet.cards;
      const teamNames = Object.keys(teams);
      const totalCards = teamNames.reduce((sum, team) => sum + teams[team], 0);
      const totalCardsPerCase = computeTotalCardsPerCase(currentSet);

      let totalCostOfBusiness = 0;
      const teamData = [];

      teamNames.forEach(team => {
        const teamCards = teams[team];
        const distribution = teamCards / totalCards;
        const distributedCost = costCase * distribution;
        const transactionCost = distributedCost * (1 + blendedTax / 100) * 0.029 + 0.30;
        const costBusinessTeam = suppliesCost + transactionCost;
        totalCostOfBusiness += costBusinessTeam;

        const avgCardsCase = totalCardsPerCase 
          ? (distribution * totalCardsPerCase) 
          : null;
        const baseline = usePercent 
          ? distributedCost * (1 + markupVal / 100)
          : distributedCost + (markupVal * distribution);

        teamData.push({
          team,
          teamCards,
          distribution,
          avgCardsCase,
          baseline
        });
      });

      // Check the toggle & input for each team
      teamData.forEach(data => {
        const toggleElem = document.getElementById("boost-toggle-" + data.team);
        const inputElem = document.getElementById("boost-input-" + data.team);
        let value = inputElem ? parseFloat(inputElem.value) || 0 : 0;
        data.boost = 0;
        data.discount = 0;

        if (value > 0) {
          if (toggleElem && toggleElem.checked) {
            // discount
            data.discount = value;
          } else {
            // boost
            data.boost = value;
          }
        }
      });

      // Compute the adjusted prices after boosts
      let boostExtraPool = 0;
      const boostedTeams = [];
      const nonBoostedTeams = [];
      teamData.forEach(data => {
        if (data.boost > 0) {
          let boostAmount = data.baseline * (data.boost / 100);
          data.adjusted = data.baseline + boostAmount;
          boostExtraPool += boostAmount;
          boostedTeams.push(data);
        } else {
          nonBoostedTeams.push(data);
        }
      });
      if (nonBoostedTeams.length > 0) {
        let boostShare = boostExtraPool / nonBoostedTeams.length;
        nonBoostedTeams.forEach(data => {
          data.adjusted = data.baseline - boostShare;
        });
      }

      // Compute final prices after discounts
      let discountPool = 0;
      const discountTeams = [];
      const nonDiscountTeams = [];
      teamData.forEach(data => {
        if (data.discount > 0) {
          let discountAmount = data.adjusted * (data.discount / 100);
          data.final = data.adjusted - discountAmount;
          discountPool += discountAmount;
          discountTeams.push(data);
        } else {
          nonDiscountTeams.push(data);
        }
      });
      if (nonDiscountTeams.length > 0) {
        let discountShare = discountPool / nonDiscountTeams.length;
        nonDiscountTeams.forEach(data => {
          data.final = data.adjusted + discountShare;
        });
      }

      teamData.forEach(data => {
        data.teamPrice = data.final;
      });

      // Identify the teams with key rookies for highlight
      const keyPlayers = config["Key Players"] || config.keyPlayers;
      const selectedYear = document.getElementById('setYearSelect').value;
      let keyRookieTeams = new Set();
      if (keyPlayers && Array.isArray(keyPlayers)) {
        keyPlayers.forEach(player => {
          if (
            player.type &&
            player.type.toLowerCase() === 'rookie' &&
            player.setYear === selectedYear &&
            (player.Team || player.team)
          ) {
            keyRookieTeams.add(player.Team || player.team);
          }
        });
      }

      // Rebuild the table
      const tbody = document.getElementById('team-table').querySelector('tbody');
      tbody.innerHTML = "";

      teamData.forEach(data => {
        const currentInput = document.getElementById("boost-input-" + data.team);
        let currentValue = currentInput ? parseFloat(currentInput.value) || 0 : 0;

        // Decide the toggle color:
        // Grey if 0; green if boost>0; blue if discount>0
        let toggleColor = 'grey';
        if (currentValue > 0) {
          toggleColor = (data.boost > 0) ? 'green' : 'blue';
        }

        // If team is associated with a key rookie, highlight row + add key emoji
        const isKeyRookieTeam = keyRookieTeams.has(data.team);
        const rowClass = isKeyRookieTeam ? 'key-rookie-row' : '';
        const teamDisplayName = isKeyRookieTeam 
            ? `${data.team} üîë` 
            : data.team;

        tbody.innerHTML += `
          <tr class="${rowClass}">
            <td>
              <a href="javascript:void(0)" 
                 onclick="openTeamSearch('${data.team}')"
                 style="color:#333; text-decoration:none;">
                ${
                  config.images 
                  && config.images["team images"] 
                  && config.images["team images"][data.team] 
                    ? `<img src="${config.images["team images"][data.team]}" 
                              alt="${data.team}"
                              style="width:30px;height:30px;
                                     object-fit:contain;
                                     margin-right:5px;
                                     vertical-align:middle;">`
                    : ""
                }
                ${teamDisplayName}
              </a>
              <a href="javascript:void(0)" 
                 onclick="openTeamSearch('${data.team}')" 
                 class="table-ebay-btn" 
                 style="margin-left:5px;">
                <img src="resources/ebay_button.png" alt="eBay">
              </a>
            </td>
            <td>${data.teamCards}</td>
            <td>${(data.distribution * 100).toFixed(2)}%</td>
            <td>${data.avgCardsCase !== null ? data.avgCardsCase.toFixed(2) : "N/A"}</td>
            <td>$${data.baseline.toFixed(2)}</td>
            <td>
              <div class="boost-toggle-container">
                <label class="ios-toggle" 
                       id="ios-toggle-${data.team}"
                       style="background-color: ${toggleColor};">
                  <span class="toggle-label toggle-rocket">üöÄ</span>
                  <input type="checkbox"
                         id="boost-toggle-${data.team}"
                         onchange="updateToggleBackground('${data.team}')"
                         ${data.discount > 0 ? 'checked' : ''} />
                  <span class="toggle-slider"></span>
                  <span class="toggle-label toggle-scissors">‚úÇÔ∏è</span>
                </label>
                <input type="number"
                       class="boost-input"
                       id="boost-input-${data.team}"
                       step="0.1"
                       min="0"
                       value="${
                         data.boost > 0 
                           ? data.boost 
                           : (data.discount > 0 
                                 ? data.discount 
                                 : 0)
                       }"
                       oninput="updateToggleBackground('${data.team}')"
                       style="width:60px;">
              </div>
            </td>
            <td>$${data.teamPrice.toFixed(2)}</td>
          </tr>
        `;
      });

      // Calculate break summary
      const markupAmount = costWithMarkup - costCase;
      const breakersProfit = markupAmount - whatnotsCut - totalCostOfBusiness;

      const breakTiles = document.getElementById('break-tiles');
      breakTiles.innerHTML = "";

      const tileProfit = document.createElement('div');
      tileProfit.className = 'tile';
      tileProfit.textContent = "Breaker's Profit: $" + breakersProfit.toFixed(2);
      tileProfit.style.background = "#66bb6a";
      tileProfit.style.color = "#fff";
      tileProfit.style.borderRadius = "4px";
      tileProfit.style.padding = "10px";
      breakTiles.appendChild(tileProfit);

      const tileWhatnots = document.createElement('div');
      tileWhatnots.className = 'tile';
      tileWhatnots.textContent = "Whatnots Cut: $" + whatnotsCut.toFixed(2);
      tileWhatnots.style.background = "#ffa726";
      tileWhatnots.style.color = "#fff";
      tileWhatnots.style.borderRadius = "4px";
      tileWhatnots.style.padding = "10px";
      breakTiles.appendChild(tileWhatnots);

      const tileBusiness = document.createElement('div');
      tileBusiness.className = 'tile';
      tileBusiness.textContent = "Cost of Business: $" + totalCostOfBusiness.toFixed(2);
      tileBusiness.style.background = "#42a5f5";
      tileBusiness.style.color = "#fff";
      tileBusiness.style.borderRadius = "4px";
      tileBusiness.style.padding = "10px";
      breakTiles.appendChild(tileBusiness);

      // Render the pie chart
      const pieData = [
        { label: "Profit", value: breakersProfit },
        { label: "Whatnots", value: whatnotsCut },
        { label: "Business", value: totalCostOfBusiness }
      ];
      updatePieChart(pieData);
    }

    function updatePieChart(data) {
      const ctx = document.getElementById('pieChart').getContext('2d');
      const labels = data.map(d => d.label);
      const values = data.map(d => d.value);
      const backgroundColors = ["#66bb6a", "#ffa726", "#42a5f5"];

      if (pieChartInstance) {
        pieChartInstance.data.labels = labels;
        pieChartInstance.data.datasets[0].data = values;
        pieChartInstance.update();
      } else {
        pieChartInstance = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: labels,
            datasets: [{
              data: values,
              backgroundColor: backgroundColors,
              borderColor: "#fff",
              borderWidth: 2,
            }]
          },
          options: {
            responsive: false,
            animation: {
              animateRotate: true,
              animateScale: true,
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.label || '';
                    let value = context.parsed;
                    return label + ': $' + value.toFixed(2);
                  }
                }
              }
            }
          }
        });
      }
    }

    // The external search links
    function openDacardworldSearch() {
      const selectedSet = document.getElementById("setNameSelect").value;
      const selectedYear = document.getElementById("setYearSelect").value;
      if (!selectedSet || !selectedYear) {
        alert("Please select a set and year first.");
        return;
      }
      const yearPrefix = selectedYear.split("-")[0];
      const query = yearPrefix + " " + selectedSet + " hockey hobby case";
      window.open("https://www.dacardworld.com/search/?Search=" + encodeURIComponent(query), "_blank");
    }
    function openSteelCitySearch() {
      const selectedSet = document.getElementById("setNameSelect").value;
      const selectedYear = document.getElementById("setYearSelect").value;
      if (!selectedSet || !selectedYear) {
        alert("Please select a set and year first.");
        return;
      }
      const yearPrefix = selectedYear.split("-")[0];
      const query = yearPrefix + " " + selectedSet + " hockey hobby case";
      window.open("https://www.steelcitycollectibles.com/search?q=" + encodeURIComponent(query), "_blank");
    }
    function openOotbSearch() {
      const selectedSet = document.getElementById("setNameSelect").value;
      const selectedYear = document.getElementById("setYearSelect").value;
      if (!selectedSet || !selectedYear) {
        alert("Please select a set and year first.");
        return;
      }
      const yearPrefix = selectedYear.split("-")[0];
      const query = yearPrefix + " " + selectedSet + " hockey hobby case";
      window.open("https://www.outoftheboxcards.com/?s=" + encodeURIComponent(query), "_blank");
    }
    function openMidwestCardsSearch() {
      const selectedSet = document.getElementById("setNameSelect").value;
      const selectedYear = document.getElementById("setYearSelect").value;
      if (!selectedSet || !selectedYear) {
        alert("Please select a set and year first.");
        return;
      }
      const yearPrefix = selectedYear.split("-")[0];
      const query = yearPrefix + " " + selectedSet + " hockey hobby case";
      window.open("https://www.midwestcards.com/search/?search_query=" + encodeURIComponent(query), "_blank");
    }
    function openTcdbSearch() {
      const selectedSet = document.getElementById("setNameSelect").value;
      const selectedYear = document.getElementById("setYearSelect").value;
      if (!selectedSet || !selectedYear) {
        alert("Please select a set and year first.");
        return;
      }
      const yearPrefix = selectedYear.split("-")[0];
      const query = yearPrefix + " " + selectedSet;
      window.open("https://www.tcdb.com/Search.cfm?SearchCategory=Hockey&q=" + encodeURIComponent(query), "_blank");
    }
    function openHockeyChecklistsSearch() {
      const selectedSet = document.getElementById("setNameSelect").value;
      const selectedYear = document.getElementById("setYearSelect").value;
      if (!selectedSet || !selectedYear) {
        alert("Please select a set and year first.");
        return;
      }
      const yearPrefix = selectedYear.split("-")[0];
      const query = yearPrefix + " " + selectedSet;
      window.open("https://hockeychecklists.com/checklist?search=" + encodeURIComponent(query), "_blank");
    }

    // Example: open eBay search for a particular player
    function openPlayerEbaySearch(player) {
      const query = player + " rookie card";
      window.open("https://www.ebay.com/sch/i.html?_nkw=" + encodeURIComponent(query), "_blank");
    }

    // Example: open eBay search for a particular team
    function openTeamSearch(team) {
      const query = team + " hockey cards";
      window.open("https://www.ebay.com/sch/i.html?_nkw=" + encodeURIComponent(query), "_blank");
    }

    // Load config once page is ready
    loadConfig();
  </script>
</body>
</html>
