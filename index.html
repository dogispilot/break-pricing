<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Skunksniper.com</title>
  <!-- Include Chart.js library -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Load custom fonts */
    @font-face {
      font-family: 'BreakPricingFont';
      src: url('fonts/breakpricingfont.ttf') format('truetype');
    }
    @font-face {
      font-family: 'BreakPricingFontBold';
      src: url('fonts/breakpricingfont_bold.ttf') format('truetype');
    }
    *, *:before, *:after {
      box-sizing: border-box;
    }
    body {
      font-family: 'BreakPricingFont', sans-serif;
      margin: 20px;
      background: #f9f9f9;
      color: #333;
    }
    h1, h2 {
      font-family: 'BreakPricingFontBold', sans-serif;
    }
    header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    header img {
      width: 50px;
      height: 50px;
      margin-right: 10px;
    }
    header h1 {
      margin: 0;
      font-size: 2em;
    }
    header a {
      margin-left: auto;
      text-decoration: none;
      color: #333;
      font-weight: bold;
      font-size: 1em;
    }
    header p {
      font-style: italic;
      margin: 0 0 0 60px;
      color: #666;
    }
    section {
      background: #fff;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    /* Set and Year Selection */
    #set-selection p {
      font-size: 1.5em;
      font-weight: 900;
      color: #1a1a1a;
    }
    #set-selection select {
      width: auto;
      display: inline-block;
      font-family: 'BreakPricingFont', sans-serif;
      font-weight: 900;
      color: #1a1a1a;
      text-decoration: underline;
      background: transparent;
      border: none;
      padding: 0;
      margin: 0 5px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      font-size: inherit;
    }
    /* Set Details ‚Äì tiles restored */
    #set-notes {
      display: none;
      padding: 10px;
      border: 1px dashed #aaa;
      margin-top: 5px;
    }
    .tile-container {
      margin-top: 10px;
      width: 100%;
    }
    .tile {
      background: #eaeaea;
      border-radius: 4px;
      text-align: center;
      padding: 10px;
    }
    .tile-value {
      font-family: 'BreakPricingFontBold', sans-serif;
      margin-bottom: 5px;
    }
    .tile-desc {
      font-size: 1em;
    }
    .hero-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      /* Keep hero tiles on one row */
      flex-wrap: nowrap;
    }
    .support-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    /* Ensure hero tiles take 50% width */
    .hero-row .tile.hero {
      flex: 0 0 50%;
    }
    /* Ensure support tiles take 25% width */
    .support-row .tile {
      flex: 0 0 25%;
    }
    /* Add 10px space below the TCDB and HockeyChecklists.com buttons */
    .button-container {
      margin-bottom: 10px;
    }
    /* Break Sniffer Layout ‚Äì two columns */
    .break-sniffer-flex {
      display: flex;
      gap: 20px;
    }
    .break-controls-container {
      width: auto;
    }
    .results-column {
      flex: 1;
    }
    /* Stack all left column items vertically */
    .break-controls-row {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: stretch;
    }
    .input-group {
      margin-bottom: 10px;
    }
    /* Limit width of the "Cost of a case" label */
    #caseCostLabel {
      display: inline-block;
      width: 110px;
    }
    /* Wrapper for price lookup/settings buttons */
    .price-button-wrapper {
      margin: 10px 0;
    }
    /* For the markup input wrapper, add 10px space below */
    .markup-wrapper {
      margin-bottom: 10px;
    }
    .input-inline {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .input-wrapper {
      display: inline-flex;
      align-items: center;
      height: 36px;
      border: 1px solid #ccc;
      border-radius: 6px;
      overflow: hidden;
      background: #fff;
    }
    .input-wrapper input[type="number"] {
      border: none;
      outline: none;
      text-align: center;
      height: 100%;
      width: 100%;
      padding: 0;
      font-size: 1em;
      font-family: inherit;
    }
    .input-wrapper .input-prefix,
    .input-wrapper .input-suffix {
      padding: 0 8px;
      background-color: #eee;
      font-size: 1em;
      font-family: inherit;
      color: #333;
      white-space: nowrap;
    }
    input[type="number"] {
      height: 36px !important;
      line-height: 36px !important;
      font-size: 1em;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 0 8px;
      font-family: 'BreakPricingFont', sans-serif;
    }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }
    .boost-input {
      width: 100%;
      border: none;
      text-align: center;
    }
    .button-group-inline {
      display: inline-flex;
      gap: 10px;
      align-items: center;
      font-family: 'BreakPricingFont', sans-serif;
    }
    .ebay-btn, .nhl-btn {
      background: none !important;
      padding: 0 !important;
      border: none !important;
      display: flex !important;
      text-decoration: none !important;
      max-width: 75%;
      height: auto;
    }
    .ebay-btn { justify-content: flex-start; }
    .nhl-btn { justify-content: flex-end; }
    .ebay-btn img, .nhl-btn img {
      max-width: 75%;
      height: auto;
      box-shadow: none !important;
    }
    .table-ebay-btn {
      background: none !important;
      padding: 0 !important;
      border: none !important;
      display: inline-block;
      width: auto;
      vertical-align: middle;
    }
    .table-ebay-btn img {
      max-height: 25px;
      width: auto;
      vertical-align: middle;
    }
    .empty-pill-button {
      background-color: transparent;
      color: #333;
      border: 1px solid #333;
      border-radius: 20px;
      padding: 2px 10px;
      cursor: pointer;
      font-size: 0.8em;
      height: 24px;
      font-family: 'BreakPricingFont', sans-serif;
      margin-left: 5px;
    }
    /* Label above break tiles */
    .profit-distribution-label {
      font-weight: bold;
      margin: 10px 0;
    }
    /* Breaker Tiles: Smaller, placed under Price Lookup */
    #break-tiles {
      display: block;
      margin-top: 15px;
      width: 100%;
    }
    .break-tile {
      max-width: 110px;
      margin-bottom: 10px;
      text-align: center;
      padding: 5px;
      vertical-align: middle;
    }
    .break-tile .tile-value {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 2px;
    }
    .break-tile .tile-label {
      font-size: 0.8em;
    }
    /* Bubble Chart Styling ‚Äì placed in the right column */
    #bubbleChartContainer {
      width: 100%;
      max-width: 100%;
      height: 600px;
    }
    #bubbleChart {
      display: block;
      width: 100%;
      height: auto;
    }
    /* iOS Toggle Switch (unchanged) */
    .toggle-switch {
      display: inline-block;
      position: relative;
      width: 50px;
      height: 24px;
      margin: 0;
      vertical-align: middle;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #66bb6a;
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    /* Rookie Tiles */
    #rookie-tiles {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    #rookie-tiles .tile {
      flex: 0 0 calc(33% - 10px);
      box-sizing: border-box;
      padding: 10px;
    }
    .rookie-team-img {
      max-width: 50%;
      height: auto;
      margin-right: 5px;
      opacity: 0.7;
      position: relative;
      z-index: 1;
    }
    .rookie-img {
      max-width: 50%;
      height: auto;
      margin: 0;
      margin-left: -60px;
      position: relative;
      z-index: 3;
    }
    .rookie-notes {
      font-size: 0.9em;
      color: #555;
      margin-bottom: 5px;
    }
    .rookie-image-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0px;
    }
    /* Table Styling ‚Äì team images in table use dedicated class */
    .table-team-img {
      width: 40px;
      height: 40px;
      object-fit: contain;
      margin-right: 5px;
      vertical-align: middle;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 8px;
      text-align: center;
      vertical-align: middle;
    }
    th {
      cursor: pointer;
      user-select: none;
    }
    #team-table td:first-child {
      text-align: left;
    }
    .lookup-button {
      padding: 8px 12px;
      font-size: 0.9rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #fff;
      color: #333;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-width: 150px;
      box-sizing: border-box;
      font-family: 'BreakPricingFont', sans-serif;
    }
    .lookup-button img {
      width: 24px;
      height: 24px;
      vertical-align: middle;
    }
    .glow-outofthebox img {
      max-height: 24px;
      width: auto;
    }
    .glow-dacardworld:hover,
    .glow-steelcity:hover,
    .glow-outofthebox:hover,
    .glow-midwestcards:hover,
    .glow-tcdb:hover,
    .glow-hockeychecklists:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      transform: scale(1.05);
    }
    #priceSettingsToggle,
    #priceLookupToggle {
      background-color: transparent;
      color: #333;
      border: 1px solid #333;
      border-radius: 20px;
      padding: 2px 10px;
      cursor: pointer;
      font-size: 0.8em;
      height: 24px;
      font-family: 'BreakPricingFont', sans-serif;
      width: 120px;
    }
    /* Floating dialogs for price menus */
    #price-settings, #price-lookup-menu {
      position: absolute;
      background: #fff;
      border: 2px solid #333;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.6);
      z-index: 1000;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <img src="resources/skunk.png" alt="Skunk logo">
    <h1>Skunksniper.com</h1>
    <a href="about.html">About</a>
  </header>
  <p>Sniff out the best breaks</p>
  <!-- Section 1: Set and Year Selection -->
  <section id="set-selection">
    <p>
      I want to explore 
      <select id="setNameSelect">
        <option value="">-- Select Set Name --</option>
      </select>
      for the years 
      <select id="setYearSelect">
        <!-- Populated by config -->
      </select>
    </p>
  </section>
  <!-- Section 2: Set Details -->
  <section id="set-details">
    <h2>üìù Set Details</h2>
    <div class="button-container">
      <button type="button" class="lookup-button glow-tcdb" onclick="openTcdbSearch()">
        <img src="resources/tcdb.jpg" alt="TCDB Logo"> TCDB
      </button>
      <button type="button" class="lookup-button glow-hockeychecklists" onclick="openHockeyChecklistsSearch()">
        <img src="resources/hockeychecklists.png" alt="HockeyChecklists Logo"> HockeyChecklists.com
      </button>
    </div>
    <div id="details-text"></div>
    <a href="#" id="toggleNotes" style="text-decoration:underline;">Read Set Notes</a>
    <div id="set-notes"></div>
    <div class="tile-container" id="set-tiles">
      <!-- Hero row (2 tiles) and support row (4 tiles) will be added here -->
    </div>
  </section>
  <!-- Section 3: Key Rookies -->
  <section id="key-rookies">
    <h2 id="keyRookiesHeader">üîë Key Rookies</h2>
    <div class="tile-container" id="rookie-tiles">
      <!-- Key rookie tiles will be generated here -->
    </div>
  </section>
  <!-- Section 4: Break Sniffer -->
  <section id="break-sniffer">
    <h2>üëÉ Break Sniffer</h2>
    <div class="break-sniffer-flex">
      <!-- Left Column: Inputs, Buttons, and Breaker Tiles -->
      <div class="break-controls-container">
        <!-- Changed break-controls-row to stack vertically -->
        <div class="break-controls-row">
          <div class="input-group">
            <label for="caseCost" id="caseCostLabel">Cost of a case</label>
            <div class="input-inline">
              <div class="input-wrapper" style="width:120px;">
                <span class="input-prefix">$</span>
                <input type="number" id="caseCost" step="0.01" value="1999.95">
              </div>
            </div>
          </div>
          <!-- Price Lookup button below cost input -->
          <div class="price-button-wrapper">
            <button id="priceLookupToggle" type="button">üîé Price Lookup</button>
          </div>
          <div class="input-group">
            <label for="markupValue">Markup</label>
            <div class="input-wrapper markup-wrapper" style="width:120px;">
              <span class="input-prefix markup-prefix" style="display: none;">$</span>
              <input type="number" id="markupValue" step="0.01" value="500">
              <span class="input-suffix markup-suffix" style="display: none;">%</span>
            </div>
          </div>
          <!-- Price Settings button below markup input -->
          <div class="price-button-wrapper">
            <button id="priceSettingsToggle" type="button">üéõÔ∏è Price Settings</button>
          </div>
        </div>
        <!-- Price Settings Dialog (hidden by default) -->
        <div id="price-settings" style="display: none;">
          <span class="dialog-close" onclick="document.getElementById('price-settings').style.display='none'">√ó</span>
          <div class="price-setting-group">
            <label for="markupToggle">Use % markup</label>
            <label class="toggle-switch">
              <input type="checkbox" id="markupToggle">
              <span class="slider"></span>
            </label>
          </div>
          <div class="price-setting-group">
            <label for="suppliesCost">Supplies per team</label>
            <div class="input-wrapper" style="width:80px;">
              <span class="input-prefix">$</span>
              <input type="number" id="suppliesCost" step="0.01" value="1.00">
            </div>
          </div>
          <div class="price-setting-group">
            <label for="blendedTax">Blended tax</label>
            <div class="input-wrapper" style="width:80px;">
              <input type="number" id="blendedTax" step="0.1" value="5.1">
              <span class="input-suffix">%</span>
            </div>
          </div>
        </div>
        <!-- Price Lookup Dialog (hidden by default) -->
        <div id="price-lookup-menu" style="display: none;">
          <span class="dialog-close" onclick="document.getElementById('price-lookup-menu').style.display='none'">√ó</span>
          <div class="button-container">
            <button type="button" class="lookup-button glow-dacardworld" onclick="openDacardworldSearch()">
              <img src="resources/dacardworld.png" alt="Dacardworld Logo">
              Dacardworld.com
            </button>
            <button type="button" class="lookup-button glow-steelcity" onclick="openSteelCitySearch()">
              <img src="https://www.steelcitycollectibles.com/storage/img/logo-scc.svg" alt="Steel City Logo">
              SteelCityCollectibles.com
            </button>
            <button type="button" class="lookup-button glow-outofthebox" onclick="openOotbSearch()">
              <img src="resources/ootb.png" alt="Out of the Box Logo">
              Out of the Box
            </button>
            <button type="button" class="lookup-button glow-midwestcards" onclick="openMidwestCardsSearch()">
              <img src="resources/midwestcards.png" alt="Midwest Cards Logo">
              Midwest Cards
            </button>
          </div>
        </div>
        <!-- Label above break tiles -->
        <div class="profit-distribution-label">Profit Distribution</div>
        <!-- Breaker Tiles -->
        <div id="break-tiles"></div>
      </div>
      <!-- Right Column: Bubble Chart -->
      <div class="results-column">
        <div id="bubbleChartContainer">
          <canvas id="bubbleChart"></canvas>
        </div>
      </div>
    </div>
    <table id="team-table">
      <thead>
        <tr>
          <th onclick="sortTable('team')">Team</th>
          <th onclick="sortTable('teamCards')">Numbered Cards</th>
          <th onclick="sortTable('distribution')">Distribution</th>
          <th onclick="sortTable('avgCardsCase')">Avg. Cards per Case</th>
          <th onclick="sortTable('baseline')">Cost + Markup</th>
          <th>
            <span onclick="sortTable('boost')">Boost</span>
            <button class="empty-pill-button" onclick="resetBoosts(event)">Reset</button>
          </th>
          <th onclick="sortTable('teamPrice')">Team Price</th>
        </tr>
      </thead>
      <tbody>
        <!-- Table rows will be generated here -->
      </tbody>
    </table>
  </section>
  <span id="hiddenSelectText" style="visibility: hidden; position: absolute; white-space: nowrap;"></span>
  <script>
    // Global image cache for bubble chart images
    let imageCache = {};
    let currentSortColumn = null;
    let currentSortDirection = 1;
    let bubbleChartInstance = null;
    function sortTable(key) {
      if (currentSortColumn === key) {
        currentSortDirection *= -1;
      } else {
        currentSortColumn = key;
        currentSortDirection = 1;
      }
      updateBreakSniffer();
    }
    function updateSelectWidth(selectElement) {
      var selectedText = selectElement.options[selectElement.selectedIndex].text;
      var hiddenSpan = document.getElementById('hiddenSelectText');
      var computedStyles = window.getComputedStyle(selectElement);
      hiddenSpan.style.fontSize = computedStyles.fontSize;
      hiddenSpan.style.fontWeight = computedStyles.fontWeight;
      hiddenSpan.style.fontFamily = computedStyles.fontFamily;
      hiddenSpan.style.textDecoration = computedStyles.textDecoration;
      hiddenSpan.textContent = selectedText;
      var textWidth = hiddenSpan.getBoundingClientRect().width;
      selectElement.style.width = textWidth + "px";
    }
    function updateAllSelectWidths() {
      updateSelectWidth(document.getElementById('setNameSelect'));
      updateSelectWidth(document.getElementById('setYearSelect'));
    }
    window.addEventListener('load', updateAllSelectWidths);
    function updateMarkupUnit() {
      const isPercent = document.getElementById('markupToggle').checked;
      const prefix = document.querySelector('.markup-prefix');
      const suffix = document.querySelector('.markup-suffix');
      prefix.style.display = isPercent ? 'none' : 'inline';
      suffix.style.display = isPercent ? 'inline' : 'none';
    }
    let config = null;
    let currentSet = null;
    let breakSnifferTimeout;
    function debouncedUpdateBreakSniffer() {
      clearTimeout(breakSnifferTimeout);
      breakSnifferTimeout = setTimeout(updateBreakSniffer, 300);
    }
    async function loadConfig() {
      try {
        const response = await fetch('config.json');
        config = await response.json();
        populateYearDropdown();
        updateSetNameDropdown();
        updateAllSelectWidths();
        document.querySelectorAll('#break-controls-row input, #price-settings input').forEach(input => {
          input.addEventListener('input', debouncedUpdateBreakSniffer);
        });
        document.getElementById('setNameSelect').addEventListener('change', function() {
          updateSelectWidth(this);
        });
        document.getElementById('setYearSelect').addEventListener('change', function() {
          updateSelectWidth(this);
        });
        document.getElementById('markupToggle').addEventListener('change', updateMarkupUnit);
        updateMarkupUnit();
        // Position dialogs next to buttons
        document.getElementById('priceSettingsToggle').addEventListener('click', function(e) {
          const btnRect = this.getBoundingClientRect();
          const ps = document.getElementById('price-settings');
          ps.style.top = (btnRect.bottom + window.scrollY + 5) + "px";
          ps.style.left = (btnRect.left + window.scrollX) + "px";
          ps.style.display = (ps.style.display === 'none' || ps.style.display === '') ? 'block' : 'none';
        });
        document.getElementById('priceLookupToggle').addEventListener('click', function(e) {
          const btnRect = this.getBoundingClientRect();
          const pl = document.getElementById('price-lookup-menu');
          pl.style.top = (btnRect.bottom + window.scrollY + 5) + "px";
          pl.style.left = (btnRect.left + window.scrollX) + "px";
          pl.style.display = (pl.style.display === 'none' || pl.style.display === '') ? 'block' : 'none';
        });
        onSelectionChange();
      } catch (error) {
        console.error("Error loading config.json:", error);
      }
    }
    function populateYearDropdown() {
      const setYearSelect = document.getElementById('setYearSelect');
      let years = new Set();
      config.sets.forEach(s => { years.add(s.year); });
      years = Array.from(years).sort();
      const defaultYear = years[years.length - 1];
      years.forEach(year => {
        const opt = document.createElement('option');
        opt.value = year;
        opt.textContent = year;
        if (year === defaultYear) opt.selected = true;
        setYearSelect.appendChild(opt);
      });
    }
    function updateSetNameDropdown() {
      const year = document.getElementById('setYearSelect').value;
      const setNameSelect = document.getElementById('setNameSelect');
      const currentSelected = setNameSelect.value;
      setNameSelect.innerHTML = "";
      const defaultOpt = document.createElement('option');
      defaultOpt.value = "";
      defaultOpt.textContent = "-- Select Set Name --";
      setNameSelect.appendChild(defaultOpt);
      const filteredSets = config.sets.filter(s => s.year === year);
      const uniqueNames = [...new Set(filteredSets.map(s => s.name))].sort();
      let found = false;
      uniqueNames.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        if(name === currentSelected) { opt.selected = true; found = true; }
        setNameSelect.appendChild(opt);
      });
      if (!found) { setNameSelect.value = ""; }
      updateSelectWidth(setNameSelect);
    }
    document.getElementById('setYearSelect').addEventListener('change', function() {
      updateSetNameDropdown();
      onSelectionChange();
    });
    document.getElementById('setNameSelect').addEventListener('change', onSelectionChange);
    document.getElementById('toggleNotes').addEventListener('click', function(e){
      e.preventDefault();
      const notesDiv = document.getElementById('set-notes');
      notesDiv.style.display = (notesDiv.style.display === 'none' || notesDiv.style.display === '') ? 'block' : 'none';
    });
    function onSelectionChange() {
      const setName = document.getElementById('setNameSelect').value;
      const setYear = document.getElementById('setYearSelect').value;
      currentSet = config.sets.find(s => s.name === setName && s.year === setYear);
      if (currentSet) {
        document.getElementById('caseCostLabel').textContent =
          `Cost of a ${currentSet.year} ${currentSet.name} case`;
        document.getElementById('keyRookiesHeader').textContent =
          `üîë ${currentSet.year} Key Rookies`;
      } else {
        document.getElementById('caseCostLabel').textContent = "Cost of a case";
        document.getElementById('keyRookiesHeader').textContent = "üîë Key Rookies";
      }
      updateSetDetails();
      updateBreakCaseCost();
      updateKeyRookies();
      updateBreakSniffer();
      if (!currentSet) {
        document.getElementById('toggleNotes').style.display = 'none';
        document.getElementById('details-text').textContent = "";
        document.getElementById('set-tiles').innerHTML = "";
        document.getElementById('team-table').querySelector('tbody').innerHTML = "";
      } else {
        document.getElementById('toggleNotes').style.display = 'inline';
      }
    }
    function updateBreakCaseCost() {
      if (currentSet && currentSet.price) {
        const priceNum = parseFloat(currentSet.price.replace(/[^0-9.]/g, ''));
        if (!isNaN(priceNum)) { 
          document.getElementById('caseCost').value = priceNum.toFixed(2); 
        }
      }
    }
    function updateSetDetails() {
      const detailsDiv = document.getElementById('details-text');
      const notesDiv = document.getElementById('set-notes');
      const tilesDiv = document.getElementById('set-tiles');
      if (!currentSet) {
        detailsDiv.textContent = "";
        notesDiv.textContent = "";
        tilesDiv.innerHTML = "";
        return;
      }
      detailsDiv.textContent = `${currentSet.year} ${currentSet.name} was released on ${currentSet.release_date}. The configuration is ${currentSet.configuration}.`;
      notesDiv.textContent = currentSet.notes || "No additional notes available.";
      tilesDiv.innerHTML = "";
      // Create hero row (2 tiles) on a single row
      const heroContainer = document.createElement('div');
      heroContainer.className = 'hero-row';
      const heroTile1 = document.createElement('div');
      heroTile1.className = 'tile hero';
      heroTile1.innerHTML = `<div class="tile-value">${currentSet.rookie_percentage || "N/A"}</div><div class="tile-desc">Rookie %</div>`;
      heroContainer.appendChild(heroTile1);
      const totalCardsPerCase = computeTotalCardsPerCase(currentSet);
      const heroTile2 = document.createElement('div');
      heroTile2.className = 'tile hero';
      heroTile2.innerHTML = `<div class="tile-value">${totalCardsPerCase || "N/A"}</div><div class="tile-desc">Total Cards per Case</div>`;
      heroContainer.appendChild(heroTile2);
      // Create support row (4 tiles) on the next row
      const supportContainer = document.createElement('div');
      supportContainer.className = 'support-row';
      const tileBoxes = document.createElement('div');
      tileBoxes.className = 'tile';
      tileBoxes.innerHTML = `<div class="tile-value">${currentSet.boxes_per_case || "N/A"}</div><div class="tile-desc">Boxes per Case</div>`;
      supportContainer.appendChild(tileBoxes);
      const tilePacks = document.createElement('div');
      tilePacks.className = 'tile';
      tilePacks.innerHTML = `<div class="tile-value">${currentSet.packs_per_box || "N/A"}</div><div class="tile-desc">Packs per Box</div>`;
      supportContainer.appendChild(tilePacks);
      const tileCardsPack = document.createElement('div');
      tileCardsPack.className = 'tile';
      tileCardsPack.innerHTML = `<div class="tile-value">${currentSet.cards_per_pack || "N/A"}</div><div class="tile-desc">Cards per Pack</div>`;
      supportContainer.appendChild(tileCardsPack);
      const cardsPerBox = computeCardsPerBox(currentSet);
      const tileCardsBox = document.createElement('div');
      tileCardsBox.className = 'tile';
      tileCardsBox.innerHTML = `<div class="tile-value">${cardsPerBox || "N/A"}</div><div class="tile-desc">Cards per Box</div>`;
      supportContainer.appendChild(tileCardsBox);
      tilesDiv.appendChild(heroContainer);
      tilesDiv.appendChild(supportContainer);
    }
    function computeTotalCardsPerCase(setObj) {
      const boxes = parseFloat(setObj.boxes_per_case);
      const packs = parseFloat(setObj.packs_per_box);
      const cards = parseFloat(setObj.cards_per_pack);
      if (isNaN(boxes) || isNaN(packs) || isNaN(cards)) return null;
      return boxes * packs * cards;
    }
    function computeCardsPerBox(setObj) {
      const packs = parseFloat(setObj.packs_per_box);
      const cards = parseFloat(setObj.cards_per_pack);
      if (isNaN(packs) || isNaN(cards)) return null;
      return packs * cards;
    }
    function openPlayerEbaySearch(playerName) {
      const setName = document.getElementById("setNameSelect").value;
      const setYear = document.getElementById("setYearSelect").value;
      if (!setName || !setYear) { alert("Please select both a set and year."); return; }
      const yearPrefix = setYear.split("-")[0];
      const query = yearPrefix + " " + setName + " " + playerName;
      window.open("https://www.ebay.com/sch/i.html?_nkw=" + encodeURIComponent(query) +
                  "&_sop=16&rt=nc&LH_Sold=1&LH_Complete=1", "_blank");
    }
    function openTeamSearch(teamName) {
      const setName = document.getElementById("setNameSelect").value;
      const setYear = document.getElementById("setYearSelect").value;
      if (!setName || !setYear) { alert("Please select a set and year."); return; }
      const yearPrefix = setYear.split("-")[0];
      const query = yearPrefix + " " + setName + " " + teamName;
      window.open("https://www.ebay.com/sch/i.html?_nkw=" + encodeURIComponent(query) +
                  "&_sop=16&rt=nc&LH_Sold=1&LH_Complete=1", "_blank");
    }
    function updateKeyRookies() {
      const rookieContainer = document.getElementById('rookie-tiles');
      rookieContainer.innerHTML = "";
      const selectedYear = document.getElementById('setYearSelect').value;
      let keyPlayers = config["Key Players"] || config.keyPlayers;
      if (keyPlayers && Array.isArray(keyPlayers)) {
        const keyRookies = keyPlayers.filter(player => {
          const teamKey = player.Team || player.team;
          return player.type && player.type.toLowerCase() === 'rookie' &&
                 player.setYear === selectedYear && teamKey;
        });
        if (keyRookies.length > 0) {
          keyRookies.forEach(player => {
            const tile = document.createElement('div');
            tile.className = 'tile';
            const teamKey = player.Team || player.team;
            const teamImage = config.images && config.images["team images"] && 
                              config.images["team images"][teamKey] ? config.images["team images"][teamKey] : "";
            tile.innerHTML = `<strong>${player.player}</strong>
              <div class="rookie-notes">${player.notes || ""}</div>
              <div class="rookie-image-container">
                ${ teamImage ? `<img class="rookie-team-img key-rookie-logo" src="${teamImage}" alt="${teamKey}">` : "" }
                <img class="rookie-img" src="${player.image}" alt="${player.player}">
              </div>`;
            const btnContainer = document.createElement('div');
            btnContainer.style.display = "inline-flex";
            btnContainer.style.gap = "15px";
            btnContainer.style.marginTop = "8px";
            const nhlLink = document.createElement("a");
            nhlLink.href = player.profile_link;
            nhlLink.target = "_blank";
            nhlLink.className = "nhl-btn";
            nhlLink.innerHTML = '<img src="resources/nhl_button.png" alt="NHL Profile">';
            btnContainer.appendChild(nhlLink);
            const ebayLink = document.createElement("a");
            ebayLink.href = "javascript:void(0)";
            ebayLink.className = "ebay-btn";
            ebayLink.onclick = function() { openPlayerEbaySearch(player.player); };
            ebayLink.innerHTML = '<img src="resources/ebay_button.png" alt="eBay">';
            btnContainer.appendChild(ebayLink);
            tile.appendChild(btnContainer);
            rookieContainer.appendChild(tile);
          });
        } else {
          rookieContainer.textContent = "No key rookie players found for the selected year.";
        }
      } else {
        rookieContainer.textContent = "No key players data available.";
      }
    }
    function updateBreakSniffer() {
      if (!currentSet) {
        document.getElementById('team-table').querySelector('tbody').innerHTML = "";
        return;
      }
      const costCase = parseFloat(document.getElementById('caseCost').value);
      const markupVal = parseFloat(document.getElementById('markupValue').value) || 0;
      const usePercent = document.getElementById('markupToggle').checked;
      const suppliesCost = parseFloat(document.getElementById('suppliesCost').value);
      const blendedTax = parseFloat(document.getElementById('blendedTax').value);
      let costWithMarkup = usePercent 
        ? costCase * (1 + markupVal / 100)
        : costCase + markupVal; 
      const whatnotsCut = costWithMarkup * 0.08;
      const teams = currentSet.cards;
      const teamNames = Object.keys(teams);
      const totalCards = teamNames.reduce((sum, team) => sum + teams[team], 0);
      const totalCardsPerCase = computeTotalCardsPerCase(currentSet);
      let totalCostOfBusiness = 0;
      const teamData = [];
      teamNames.forEach(team => {
        const teamCards = teams[team];
        const distribution = teamCards / totalCards;
        const distributedCost = costCase * distribution;
        const transactionCost = distributedCost * (1 + blendedTax / 100) * 0.029 + 0.30;
        const costBusinessTeam = suppliesCost + transactionCost;
        totalCostOfBusiness += costBusinessTeam;
        const avgCardsCase = totalCardsPerCase ? (distribution * totalCardsPerCase) : null;
        const baseline = usePercent 
          ? distributedCost * (1 + markupVal / 100)
          : distributedCost + (markupVal * distribution);
        teamData.push({
          team,
          teamCards,
          distribution,
          avgCardsCase,
          baseline
        });
      });
      teamData.forEach(data => {
        const boostInput = document.getElementById("boost-input-" + data.team);
        let boostVal = boostInput ? parseFloat(boostInput.value) || 0 : 0;
        data.boost = boostVal;
        if (data.boost > 0) {
          data.teamPrice = data.baseline + (data.baseline * (data.boost / 100));
        } else if (data.boost < 0) {
          data.teamPrice = data.baseline - (data.baseline * (Math.abs(data.boost) / 100));
        } else {
          data.teamPrice = data.baseline;
        }
      });
      if (currentSortColumn) {
        teamData.sort((a, b) => {
          let valA = a[currentSortColumn];
          let valB = b[currentSortColumn];
          if (valA === null) valA = -Infinity;
          if (valB === null) valB = -Infinity;
          if (typeof valA === "string") {
            return valA.localeCompare(valB) * currentSortDirection;
          } else {
            return (valA - valB) * currentSortDirection;
          }
        });
      }
      const tbody = document.getElementById('team-table').querySelector('tbody');
      tbody.innerHTML = "";
      teamData.forEach(data => {
        const keyPlayers = config["Key Players"] || config.keyPlayers;
        const hasKeyRookie = keyPlayers && Array.isArray(keyPlayers) && keyPlayers.some(player => {
          const teamKey = player.Team || player.team;
          return player.type && player.type.toLowerCase() === 'rookie' &&
                 player.setYear === document.getElementById('setYearSelect').value &&
                 teamKey === data.team;
        });
        const highlightStyle = hasKeyRookie ? ' style="background-color:#ffffcc;"' : '';
        const keyEmoji = hasKeyRookie ? ' üîë' : '';
        const teamImage = config.images && config.images["team images"] && config.images["team images"][data.team] 
                          ? `<img src="${config.images["team images"][data.team]}" alt="${data.team}" class="table-team-img">`
                          : "";
        let priceStyle = "";
        let emoji = "";
        if(data.boost > 0) {
          priceStyle = 'background-color:#2E7D32; color:#fff;';
          emoji = ' üöÄ';
        } else if(data.boost < 0) {
          priceStyle = 'background-color:#EF6C00; color:#fff;';
          emoji = ' ‚úÇÔ∏è';
        }
        tbody.innerHTML += `
          <tr${highlightStyle}>
            <td>
              <a href="javascript:void(0)" onclick="openTeamSearch('${data.team}')" style="color:#333; text-decoration:none;">
                ${teamImage}${data.team}${keyEmoji}
              </a>
              <a href="javascript:void(0)" onclick="openTeamSearch('${data.team}')" class="table-ebay-btn" style="margin-left:5px;">
                <img src="resources/ebay_button.png" alt="eBay">
              </a>
            </td>
            <td>${data.teamCards}</td>
            <td>${(data.distribution * 100).toFixed(2)}%</td>
            <td>${data.avgCardsCase !== null ? data.avgCardsCase.toFixed(2) : "N/A"}</td>
            <td>$${data.baseline.toFixed(2)}</td>
            <td>
              <div class="input-wrapper" style="width:60px;">
                <input type="number" class="boost-input" id="boost-input-${data.team}" step="0.1" value="${data.boost ? data.boost : ''}" oninput="debouncedUpdateBreakSniffer()">
                <span class="input-suffix">%</span>
              </div>
            </td>
            <td style="${priceStyle}">$${data.teamPrice.toFixed(2)}${emoji}</td>
          </tr>
        `;
      });
      const markupAmount = costWithMarkup - costCase;
      const breakersProfit = markupAmount - whatnotsCut - totalCostOfBusiness;
      const breakTiles = document.getElementById('break-tiles');
      breakTiles.innerHTML = "";
      const tileProfit = document.createElement('div');
      tileProfit.className = 'tile break-tile';
      tileProfit.innerHTML = `<div class="tile-value">$${breakersProfit.toFixed(2)}</div><div class="tile-label">Breaker's Profit</div>`;
      tileProfit.style.background = "#2E7D32";
      tileProfit.style.color = "#fff";
      breakTiles.appendChild(tileProfit);
      const tileWhatnots = document.createElement('div');
      tileWhatnots.className = 'tile break-tile';
      tileWhatnots.innerHTML = `<div class="tile-value">$${whatnotsCut.toFixed(2)}</div><div class="tile-label">Whatnots Cut</div>`;
      tileWhatnots.style.background = "#EF6C00";
      tileWhatnots.style.color = "#fff";
      breakTiles.appendChild(tileWhatnots);
      const tileBusiness = document.createElement('div');
      tileBusiness.className = 'tile break-tile';
      tileBusiness.innerHTML = `<div class="tile-value">$${totalCostOfBusiness.toFixed(2)}</div><div class="tile-label">Cost of Business</div>`;
      tileBusiness.style.background = "#1565C0";
      tileBusiness.style.color = "#fff";
      breakTiles.appendChild(tileBusiness);
      updateBubbleChart(teamData);
      updatePieChart([]); // Donut chart removed
    }
    // Updated Bubble Chart Function ‚Äì draws only team images.
    // The base image size is increased by 15% (from 40 to 46) and images are drawn with 0.6 opacity.
    // The x-axis tick callback now formats values to 1 decimal place and the y-axis shows no decimals.
    function updateBubbleChart(teamData) {
      const canvas = document.getElementById('bubbleChart');
      const ctx = canvas.getContext('2d');
      const baseSize = 46;
      const boostFactor = 2;
      const imageData = teamData.map(data => {
        const size = baseSize + (Math.abs(data.boost) * boostFactor);
        if (!imageCache[data.team]) {
          const img = new Image();
          img.src = (config.images && config.images["team images"] && config.images["team images"][data.team]) || "";
          img.onload = () => { if (bubbleChartInstance) bubbleChartInstance.update(); };
          imageCache[data.team] = img;
        }
        return {
          x: data.distribution * 100,
          y: data.teamPrice,
          size: size,
          team: data.team,
          boost: data.boost,
          cachedImage: imageCache[data.team]
        };
      });
      const xValues = imageData.map(d => d.x);
      const xMin = Math.min(...xValues) * 0.95;
      const xMax = Math.max(...xValues) * 1.05;
      const yValues = imageData.map(d => d.y);
      const yMin = Math.min(...yValues) * 0.95;
      const yMax = Math.max(...yValues) * 1.05;
      if (bubbleChartInstance) {
        bubbleChartInstance.data.datasets[0].data = imageData;
        bubbleChartInstance.options.scales.x.min = xMin;
        bubbleChartInstance.options.scales.x.max = xMax;
        bubbleChartInstance.options.scales.y.min = yMin;
        bubbleChartInstance.options.scales.y.max = yMax;
        bubbleChartInstance.update();
      } else {
        bubbleChartInstance = new Chart(ctx, {
          type: 'bubble',
          data: {
            datasets: [{
              label: 'Team Data',
              data: imageData,
              pointRadius: 1,
              hitRadius: (context) => context.raw.size / 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                title: { display: true, text: 'Distribution (%)' },
                min: xMin,
                max: xMax,
                ticks: {
                  beginAtZero: false,
                  callback: function(value) { return value.toFixed(1) + '%'; }
                }
              },
              y: {
                title: { display: true, text: 'Team Price ($)' },
                min: yMin,
                max: yMax,
                ticks: {
                  beginAtZero: true,
                  callback: function(value) { return '$' + value.toFixed(0); }
                }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false }
            },
            onClick: (evt) => {
              const activePoints = bubbleChartInstance.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, false);
              if (activePoints.length > 0) {
                const index = activePoints[0].index;
                const dp = bubbleChartInstance.data.datasets[0].data[index];
                alert("Team: " + dp.team +
                      "\nDistribution: " + dp.x.toFixed(2) + "%" +
                      "\nTeam Price: $" + dp.y.toFixed(2) +
                      "\nBoost: " + dp.boost + "%");
              }
            }
          },
          plugins: [{
            id: 'customImagePlugin',
            afterDatasetsDraw: (chart) => {
              const ctx = chart.ctx;
              const xScale = chart.scales.x;
              const yScale = chart.scales.y;
              chart.data.datasets[0].data.forEach((dataPoint) => {
                const x = xScale.getPixelForValue(dataPoint.x);
                const y = yScale.getPixelForValue(dataPoint.y);
                const size = dataPoint.size;
                const img = dataPoint.cachedImage;
                if (dataPoint.boost > 0) {
                  ctx.shadowColor = "rgba(0,255,0,1)";
                  ctx.shadowBlur = 20;
                  ctx.shadowOffsetX = 4;
                  ctx.shadowOffsetY = 4;
                } else if (dataPoint.boost < 0) {
                  ctx.shadowColor = "rgba(255,0,0,1)";
                  ctx.shadowBlur = 20;
                  ctx.shadowOffsetX = 4;
                  ctx.shadowOffsetY = 4;
                } else {
                  ctx.shadowColor = "transparent";
                  ctx.shadowBlur = 0;
                  ctx.shadowOffsetX = 0;
                  ctx.shadowOffsetY = 0;
                }
                if (img && img.complete) {
                  const aspect = img.width / img.height;
                  let drawWidth, drawHeight;
                  if (aspect >= 1) {
                    drawWidth = size;
                    drawHeight = size / aspect;
                  } else {
                    drawWidth = size * aspect;
                    drawHeight = size;
                  }
                  ctx.globalAlpha = 0.6;
                  ctx.drawImage(img, x - drawWidth/2, y - drawHeight/2, drawWidth, drawHeight);
                  ctx.globalAlpha = 1;
                }
                ctx.shadowColor = "transparent";
                ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
              });
            }
          }]
        });
      }
    }
    // Dummy updatePieChart function (donut chart removed)
    function updatePieChart(data) {}
    function openDacardworldSearch() {
      const selectedSet = document.getElementById("setNameSelect").value;
      const selectedYear = document.getElementById("setYearSelect").value;
      if (!selectedSet || !selectedYear) { alert("Please select a set and year first."); return; }
      const yearPrefix = selectedYear.split("-")[0];
      const query = yearPrefix + " " + selectedSet + " hockey hobby case";
      window.open("https://www.dacardworld.com/search/?Search=" + encodeURIComponent(query), "_blank");
    }
    function openSteelCitySearch() {
      const selectedSet = document.getElementById("setNameSelect").value;
      const selectedYear = document.getElementById("setYearSelect").value;
      if (!selectedSet || !selectedYear) { alert("Please select a set and year first."); return; }
      const yearPrefix = selectedYear.split("-")[0];
      const query = yearPrefix + " " + selectedSet + " hockey hobby case";
      window.open("https://www.steelcitycollectibles.com/search?q=" + encodeURIComponent(query), "_blank");
    }
    function openOotbSearch() {
      const selectedSet = document.getElementById("setNameSelect").value;
      const selectedYear = document.getElementById("setYearSelect").value;
      if (!selectedSet || !selectedYear) { alert("Please select a set and year first."); return; }
      const yearPrefix = selectedYear.split("-")[0];
      const query = yearPrefix + " " + selectedSet + " hockey hobby case";
      window.open("https://www.outoftheboxcards.com/?s=" + encodeURIComponent(query), "_blank");
    }
    function openMidwestCardsSearch() {
      const selectedSet = document.getElementById("setNameSelect").value;
      const selectedYear = document.getElementById("setYearSelect").value;
      if (!selectedSet || !selectedYear) { alert("Please select a set and year first."); return; }
      const yearPrefix = selectedYear.split("-")[0];
      const query = yearPrefix + " " + selectedSet + " hockey hobby case";
      window.open("https://www.midwestcards.com/search/?search_query=" + encodeURIComponent(query), "_blank");
    }
    function openTcdbSearch() {
      const selectedSet = document.getElementById("setNameSelect").value;
      const selectedYear = document.getElementById("setYearSelect").value;
      if (!selectedSet || !selectedYear) { alert("Please select a set and year first."); return; }
      const yearPrefix = selectedYear.split("-")[0];
      const query = yearPrefix + " " + selectedSet;
      window.open("https://www.tcdb.com/Search.cfm?SearchCategory=Hockey&q=" + encodeURIComponent(query), "_blank");
    }
    function openHockeyChecklistsSearch() {
      const selectedSet = document.getElementById("setNameSelect").value;
      const selectedYear = document.getElementById("setYearSelect").value;
      if (!selectedSet || !selectedYear) { alert("Please select a set and year first."); return; }
      const yearPrefix = selectedYear.split("-")[0];
      const query = yearPrefix + " " + selectedSet;
      window.open("https://hockeychecklists.com/checklist?search=" + encodeURIComponent(query), "_blank");
    }
    function resetBoosts(event) {
      if (event) event.stopPropagation();
      document.querySelectorAll('.boost-input').forEach(function(input) {
        input.value = 0;
      });
      updateBreakSniffer();
    }
    loadConfig();
  </script>
</body>
</html>
