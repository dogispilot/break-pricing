<!DOCTYPE html>
<html>
  <head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PL5RQPB0MT"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-PL5RQPB0MT');
    </script>
    <meta charset="UTF-8" />
    <title>SkunkSniper.com</title>
    <link rel="icon" type="image/png" href="/resources/calculator.png" />
    <!-- Import Google Fonts (Roboto remains if needed) -->
    <link
      href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap"
      rel="stylesheet"
    />
    <style>
      @font-face {
        font-family: 'BreakPricingFont';
        src: url('fonts/breakpricingfont.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
      }
      @font-face {
        font-family: 'BreakPricingFontBold';
        src: url('fonts/breakpricingfont_bold.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
      }
      body {
        font-family: 'BreakPricingFont', sans-serif;
        background-color: #121212;
        color: #e0e0e0;
        margin: 0;
        padding: 20px;
      }
      .about-link {
        position: absolute;
        top: 20px;
        right: 20px;
        color: #e0e0e0;
        text-decoration: none;
        font-size: 1rem;
        font-family: 'BreakPricingFont', sans-serif;
        z-index: 1000;
      }
      .about-link:hover {
        text-decoration: underline;
      }
      .container {
        position: relative;
        max-width: 900px;
        margin: 0 auto;
        background: #1e1e1e;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      }
      .header {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 25px;
      }
      .header img {
        width: 60px;
        height: auto;
        margin-right: 15px;
      }
      h1 {
        color: #e0e0e0;
        margin: 0;
        font-size: 2rem;
        font-family: 'BreakPricingFontBold', sans-serif;
      }
      h2 {
        text-align: center;
        color: #e0e0e0;
        margin-top: 0;
      }
      #teamPricesHeader {
        font-family: 'BreakPricingFontBold', sans-serif;
      }
      form#calcForm {
        margin-bottom: 25px;
      }
      .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
      }
      .form-row .form-group {
        flex: 1;
        min-width: 200px;
        display: flex;
        flex-direction: column;
      }
      .form-group.no-label {
        margin-top: 1.5em;
      }
      .small-input-row .form-group input,
      .small-input-row .form-group select {
        max-width: 100px;
      }
      .form-group label {
        margin-bottom: 6px;
        font-weight: 500;
        color: #e0e0e0;
      }
      .form-group input,
      .form-group select {
        padding: 12px 15px;
        font-size: 1rem;
        border: 1px solid #444;
        border-radius: 6px;
        background-color: #2c2c2c;
        color: #e0e0e0;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.5);
        transition: border 0.2s, box-shadow 0.2s;
      }
      .form-group input:focus,
      .form-group select:focus {
        border-color: #007bff;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        outline: none;
      }
      input[type="number"]::-webkit-outer-spin-button,
      input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }
      .input-button-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .form-actions {
        text-align: center;
      }
      .calculate-btn {
        width: 500px;
        padding: 16px 30px;
        background: transparent;
        border: 5px solid;
        border-image: linear-gradient(135deg, #ffde0c, #005396, #f37427) 1;
        border-radius: 20px;
        color: #ffffff;
        font-size: 1.3rem;
        text-transform: uppercase;
        font-family: 'BreakPricingFont', sans-serif;
        transition: transform 0.2s, border 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin: 0 auto;
      }
      .calculate-btn:hover {
        transform: scale(1.05);
      }
      .lookup-button {
        padding: 12px 20px;
        font-size: 1rem;
        border: 1px solid #888;
        border-radius: 6px;
        background: transparent;
        color: #fff;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
        font-family: 'BreakPricingFont', sans-serif;
      }
      .lookup-button.small {
        padding: 8px 12px;
        font-size: 0.9rem;
      }
      .lookup-button img {
        width: 24px;
        height: 24px;
        border-radius: 50%;
      }
      .lookup-button.small img {
        width: 20px;
        height: 20px;
      }
      .lookup-button:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      .steelcity-button {
        background: transparent;
        border: 1px solid #888;
        color: #fff;
      }
      .steelcity-button:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      /* Updated Key Rookies Section styles */
      #keyPlayersSection {
        margin-top: 30px;
        padding: 15px;
        background: #2c2c2c;
        border-radius: 8px;
      }
      #keyPlayersSection h2 {
        margin-top: 0;
        text-align: center;
        font-family: 'BreakPricingFontBold', sans-serif;
      }
      .key-player-tiles-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 30px; /* Increased gap */
        justify-items: center;
      }
      .key-player-tile {
        background: #1e1e1e;
        padding: 10px;
        margin: 10px 0;
        border-radius: 8px;
        display: flex;
        align-items: center;
        width: 100%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      }
      .key-player-tile img.team-logo {
        width: 30px;
        height: 30px;
        margin-right: 10px;
        border-radius: 50%;
      }
      .key-player-tile img.player-img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 10px;
      }
      .key-player-info {
        display: flex;
        flex-direction: column;
      }
      .key-player-info strong {
        font-size: 1.1rem;
        margin-bottom: 4px;
      }
      .key-player-notes {
        font-size: 0.9rem;
        color: #bbb;
      }
      /* Chart and pricing table styles */
      .chart-summary-container {
        display: flex;
        gap: 20px;
        margin-top: 30px;
        align-items: stretch;
      }
      #chartContainer {
        flex: 2;
        height: 300px;
        background: #2c2c2c;
        padding: 15px;
        border-radius: 8px;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.5);
      }
      .summary-container {
        flex: 1;
        max-width: 300px;
        display: flex;
        flex-direction: column;
        height: 300px;
      }
      .summary-container .summary-box {
        flex: 1;
        margin: 5px 0;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        font-size: 1.3rem;
        font-weight: 500;
        position: relative;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      }
      #totalProfitBox {
        background-color: transparent;
        border: 4px solid #2e7d32;
        color: #2e7d32;
      }
      #whatnotsCutBox {
        background-color: transparent;
        border: 4px solid #bfa600;
        color: #bfa600;
      }
      #costOfBusinessBox {
        background-color: transparent;
        border: 4px solid #007bff;
        color: #007bff;
      }
      .toast {
        margin-top: 8px;
        padding: 8px;
        background: rgba(0, 0, 0, 0.7);
        color: #e0e0e0;
        border-radius: 4px;
        font-size: 0.85rem;
        display: none;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        text-align: center;
        z-index: 10;
      }
      .summary-box .amount {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.25em;
        font-family: 'BreakPricingFontBold', sans-serif;
      }
      .summary-box .label {
        font-size: 1rem;
        font-weight: 400;
      }
      .link-icon {
        width: 16px;
        height: 16px;
        margin-left: 4px;
        vertical-align: middle;
      }
      .ebay-icon {
        width: 20px;
        height: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th,
      td {
        padding: 12px 15px;
        border: 1px solid #333;
        text-align: left;
      }
      th {
        background-color: #007bff;
        color: #fff;
        cursor: pointer;
        user-select: none;
      }
      th:hover {
        background-color: #0056b3;
      }
      tr:nth-child(even) {
        background-color: #2c2c2c;
      }
      tr.highlight {
        background-color: rgba(255, 222, 12, 0.2);
      }
      img.logo {
        width: 30px;
        height: 30px;
        vertical-align: middle;
        margin-right: 8px;
        border-radius: 50%;
      }
      @media (max-width: 600px) {
        .form-row .form-group {
          min-width: 100%;
        }
        .form-group input,
        .form-group select {
          font-size: 1.1rem;
          padding: 14px 18px;
        }
        .calculate-btn {
          width: 100%;
          padding: 12px 20px;
          font-size: 1.2rem;
        }
        .chart-summary-container {
          flex-direction: column;
        }
        #chartContainer,
        .summary-container {
          width: 100%;
          height: auto;
        }
        .summary-container .summary-box {
          margin: 10px 0;
        }
      }
      .glow-outofthebox:hover {
        box-shadow: 0 0 8px #f70000, 0 0 16px #f70000;
      }
      .glow-blowout:hover {
        box-shadow: 0 0 8px #9a0e20, 0 0 16px #9a0e20;
      }
      .glow-tcdb:hover {
        box-shadow: 0 0 8px #c84c19, 0 0 16px #c84c19;
      }
      .glow-daveadams:hover {
        box-shadow: 0 0 8px #27465a, 0 0 16px #27465a;
      }
      .glow-steelcity:hover {
        box-shadow: 0 0 8px #e2d61e, 0 0 16px #e2d61e;
      }
      .glow-midwestcards:hover {
        box-shadow: 0 0 8px #e8b144, 0 0 16px #e8b144;
      }
      .glow-hockeychecklists:hover {
        box-shadow: 0 0 8px #021e9b, 0 0 16px #021e9b;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="container">
      <a href="about.html" class="about-link">About</a>
      <div class="header">
        <img src="resources/skunk.png" alt="SkunkSniper Logo" />
        <h1>SkunkSniper.com</h1>
      </div>

      <!-- Calculation Form -->
      <form id="calcForm">
        <!-- Row 1: Year, Set, TCDB Button, and HockeyChecklists.com Button -->
        <div class="form-row">
          <div class="form-group">
            <label for="yearSelect">Select Year</label>
            <select id="yearSelect" required>
              <option value="">--Select a Year--</option>
            </select>
          </div>
          <div class="form-group">
            <label for="setSelect">Select a Set</label>
            <select id="setSelect" required>
              <option value="">--Select Set--</option>
            </select>
          </div>
          <div class="form-group no-label">
            <button
              type="button"
              class="lookup-button small glow-tcdb"
              onclick="openTcdbSearch()"
              style="padding: 8px 12px; justify-content: center;"
            >
              <img src="resources/tcdb.jpg" alt="TCDB Logo" />
              TCDB
            </button>
          </div>
          <div class="form-group no-label">
            <button
              type="button"
              class="lookup-button small glow-hockeychecklists"
              onclick="openHockeyChecklistsSearch()"
              style="justify-content: center;"
            >
              <img
                src="resources/hockeychecklists.png"
                alt="Hockey Checklists Icon"
              />
              HockeyChecklists.com
            </button>
          </div>
        </div>
        <!-- Row 2: Cost of a Case with Lookup Buttons -->
        <div class="form-row">
          <div class="form-group">
            <label for="casePrice">Cost of a Case ($)</label>
            <div class="input-button-group">
              <input
                type="number"
                id="casePrice"
                class="case-price-input"
                step="0.01"
                required
                placeholder="Enter price"
                value="1999.99"
              />
              <button
                type="button"
                class="lookup-button small glow-daveadams"
                onclick="openSetSearch()"
              >
                <img
                  src="https://i.pinimg.com/280x280_RS/78/07/f6/7807f6a72b75f844ed54bc06b83c3bed.jpg"
                  alt="Lookup Icon"
                />
                Dave &amp; Adams
              </button>
              <button
                type="button"
                class="lookup-button small steelcity-button glow-steelcity"
                onclick="openSteelCitySearch()"
              >
                <img
                  src="https://www.steelcitycollectibles.com/storage/img/logo-scc.svg"
                  alt="Steel City Logo"
                />
                Steel City
              </button>
              <button
                type="button"
                class="lookup-button small glow-midwestcards"
                onclick="openMidwestCardsSearch()"
              >
                <img
                  src="resources/midwestcards.png"
                  alt="Midwest Cards Logo"
                />
                Midwest Cards
              </button>
              <button
                type="button"
                class="lookup-button small glow-blowout"
                onclick="openBlowoutCardsSearch()"
              >
                <img
                  src="https://www.blowoutcards.com/skin/frontend/base/default/images/logo-BC-Trademark3.png"
                  alt="Blowout Cards Logo"
                />
                Blowout Cards
              </button>
              <button
                type="button"
                class="lookup-button small glow-outofthebox"
                onclick="openOotbSearch()"
              >
                <img src="resources/ootb.png" alt="Out of the Box Logo" />
                Out of the Box
              </button>
            </div>
          </div>
        </div>
        <!-- Row 3: Grouped smaller inputs -->
        <div class="form-row small-input-row">
          <div class="form-group">
            <label for="markup">Markup (%)</label>
            <input
              type="text"
              id="markup"
              required
              placeholder="Enter markup"
              value="30%"
            />
          </div>
          <div class="form-group">
            <label for="userDiscount">User Discount (%)</label>
            <input
              type="text"
              id="userDiscount"
              required
              placeholder="Enter discount"
              value="0%"
            />
          </div>
          <div class="form-group">
            <label for="blendedTax">Blended Tax (%)</label>
            <input
              type="text"
              id="blendedTax"
              required
              placeholder="Enter tax"
              value="5.1%"
            />
          </div>
          <div class="form-group">
            <label for="supplies">Supplies per Order ($)</label>
            <input
              type="number"
              id="supplies"
              step="0.01"
              required
              placeholder="Enter supplies cost"
              value="1"
            />
          </div>
        </div>
        <div class="form-actions">
          <button type="submit" class="calculate-btn">
            <img
              src="resources/calculator.png"
              alt="Calculator Icon"
              style="width:24px;height:24px;"
            />
            Calculate
          </button>
        </div>
      </form>

      <!-- New Key Rookies Section (updated title and spacing) placed above the pie chart -->
      <div id="keyPlayersSection" style="display:none;">
        <h2>Key Rookies</h2>
        <div class="key-player-tiles-container" id="keyPlayerTiles"></div>
      </div>

      <!-- New container for pie chart and summary boxes -->
      <div class="chart-summary-container">
        <div id="chartContainer">
          <canvas id="pieChart"></canvas>
        </div>
        <div class="summary-container">
          <div id="totalProfitBox" class="summary-box">
            <div class="amount">$0.00</div>
            <div class="label">Breaker's Profit</div>
            <div class="toast">
              Profit is how much money a breaker will make.
            </div>
          </div>
          <div id="whatnotsCutBox" class="summary-box">
            <div class="amount">$0.00</div>
            <div class="label">Whatnot's Cut</div>
            <div class="toast">
              Whatnot's cut is 8% of the breaker’s listed price, before tax.
            </div>
          </div>
          <div id="costOfBusinessBox" class="summary-box">
            <div class="amount">$0.00</div>
            <div class="label">Cost of Business</div>
            <div class="toast">
              Cost of Business includes transaction fees and additional per order supplies cost.
            </div>
          </div>
        </div>
      </div>

      <!-- Existing Suggested Team Prices Section -->
      <h2 id="teamPricesHeader" style="display: none;">Suggested Team Prices</h2>
      <div id="results"></div>
    </div>

    <script>
      // Global variables
      let setData = [];
      let keyPlayersData = [];
      let pieChart;
      let tableData = [];
      let currentSortedColumn = -1;
      // Set to track teams that have a chase player (rookie) shown
      let highlightTeams = new Set();
      const sortDirections = { 0: 1, 1: 1, 2: 1, 3: 1, 4: 1, 5: 1, 6: 1, 7: 1 };

      // Utility function to parse percentage inputs.
      function parsePercentage(value) {
        value = value.toString().replace("%", "").trim();
        let num = parseFloat(value);
        if (isNaN(num)) return 0;
        if (num > 1) return num / 100;
        return num;
      }

      // Populate the year selector with unique years in descending order.
      function populateYearSelector() {
        const yearSelect = document.getElementById("yearSelect");
        yearSelect.innerHTML =
          '<option value="">--Select a Year--</option>';
        const years = [
          ...new Set(setData.map((set) => set.year)),
        ].sort((a, b) => {
          const yearA = parseInt(a.split("-")[0], 10);
          const yearB = parseInt(b.split("-")[0], 10);
          return yearB - yearA;
        });
        years.forEach((year) => {
          const option = document.createElement("option");
          option.value = year;
          option.textContent = year;
          yearSelect.appendChild(option);
        });
        yearSelect.addEventListener("change", function () {
          populateSetSelector();
          updateKeyPlayersSection();
        });
      }

      // Populate the set selector based on the selected year.
      function populateSetSelector() {
        const selectedYear = document.getElementById("yearSelect").value;
        const setSelect = document.getElementById("setSelect");
        setSelect.innerHTML =
          '<option value="">--Select Set--</option>';
        if (!selectedYear) return;
        const filteredSets = setData.filter(
          (set) => set.year === selectedYear
        );
        filteredSets.sort((a, b) => a.name.localeCompare(b.name));
        filteredSets.forEach((set) => {
          const option = document.createElement("option");
          option.value = set.name;
          option.textContent = set.name;
          setSelect.appendChild(option);
        });
      }

      // Update the "Cost of a Case" field when a set is selected.
      function updateCasePrice() {
        const selectedYear = document.getElementById("yearSelect").value;
        const selectedSet = document.getElementById("setSelect").value;
        if (!selectedYear || !selectedSet) return;
        const setObj = setData.find(
          (set) => set.year === selectedYear && set.name === selectedSet
        );
        if (setObj && setObj.price) {
          const priceValue = parseFloat(
            setObj.price.replace(/[$,]/g, "")
          );
          document.getElementById("casePrice").value = priceValue;
        }
      }

      // New function: Opens an eBay search for the given player name
      // using the set year and set name.
      function openPlayerEbaySearch(playerName) {
        const selectedYear = document.getElementById("yearSelect").value;
        const selectedSet = document.getElementById("setSelect").value;
        if (!selectedYear || !selectedSet) {
          alert("Please select both a year and a set.");
          return;
        }
        const yearPrefix = selectedYear.split("-")[0];
        const query = yearPrefix + " " + selectedSet + " " + playerName;
        const url =
          "https://www.ebay.com/sch/i.html?_nkw=" +
          encodeURIComponent(query) +
          "&_sop=16&rt=nc&LH_Sold=1&LH_Complete=1";
        window.open(url, "_blank");
      }

      // Update Key Rookies Section based on selected year, including only rookies.
      function updateKeyPlayersSection() {
        const selectedYear = document.getElementById("yearSelect").value;
        const keySection = document.getElementById("keyPlayersSection");
        const tilesContainer = document.getElementById("keyPlayerTiles");
        // Clear previous tiles and reset highlightTeams
        tilesContainer.innerHTML = "";
        highlightTeams.clear();
        if (!selectedYear) {
          keySection.style.display = "none";
          return;
        }
        // Filter players whose setYear matches the selected year or is "All", and only include rookies.
        const filteredPlayers = keyPlayersData.filter(
          (player) =>
            (player.setYear === selectedYear || player.setYear === "All") &&
            player.type.toLowerCase() === "rookie"
        );
        if (filteredPlayers.length === 0) {
          keySection.style.display = "none";
          return;
        }
        keySection.style.display = "block";
        // Populate highlightTeams set from filtered players
        filteredPlayers.forEach((player) => {
          highlightTeams.add(player.team);
        });
        // Create a tile for each key player
        filteredPlayers.forEach((player) => {
          const tile = document.createElement("div");
          tile.className = "key-player-tile";

          // Team logo image – using your teamLogos mapping
          const teamLogo = document.createElement("img");
          teamLogo.className = "team-logo";
          teamLogo.src = teamLogos[player.team] || "";
          teamLogo.alt = player.team + " logo";
          tile.appendChild(teamLogo);

          // Player image wrapped in a link to the profile (unchanged)
          const profileLink = document.createElement("a");
          profileLink.href = player.profile_link;
          profileLink.target = "_blank";
          const playerImg = document.createElement("img");
          playerImg.className = "player-img";
          playerImg.src = player.image;
          playerImg.alt = player.player;
          profileLink.appendChild(playerImg);
          tile.appendChild(profileLink);

          // Info container with three lines: name, notes, and eBay link.
          const infoDiv = document.createElement("div");
          infoDiv.className = "key-player-info";
          
          // First line: Name as a link to the profile
          const nameLine = document.createElement("div");
          const nameLink = document.createElement("a");
          nameLink.href = player.profile_link;
          nameLink.target = "_blank";
          nameLink.style.textDecoration = "none";
          nameLink.style.color = "inherit"; // ensures it inherits text color
          nameLink.textContent = player.player;
          nameLine.appendChild(nameLink);
          infoDiv.appendChild(nameLine);
          
          // Second line: Player notes
          const notesLine = document.createElement("div");
          notesLine.className = "key-player-notes";
          notesLine.textContent = player.notes || "";
          infoDiv.appendChild(notesLine);
          
          // Third line: eBay link with share and eBay icons
          const ebayLine = document.createElement("div");
          const ebayLink = document.createElement("a");
          ebayLink.href = "javascript:void(0)";
          ebayLink.onclick = function () {
            openPlayerEbaySearch(player.player);
          };
          const shareImg = document.createElement("img");
          shareImg.src = "resources/share_white.png";
          shareImg.alt = "Share";
          shareImg.className = "link-icon";
          ebayLink.appendChild(shareImg);
          
          const ebayImg = document.createElement("img");
          ebayImg.src =
            "https://cdn4.iconfinder.com/data/icons/flat-brand-logo-2/512/ebay-1024.png";
          ebayImg.alt = "eBay";
          ebayImg.className = "link-icon ebay-icon";
          ebayLink.appendChild(ebayImg);
          ebayLine.appendChild(ebayLink);
          infoDiv.appendChild(ebayLine);
          
          tile.appendChild(infoDiv);
          tilesContainer.appendChild(tile);
        });
      }

      // Mapping of team names to logo URLs.
      const teamLogos = {
        "Anaheim Ducks": "https://assets.nhle.com/logos/nhl/svg/ANA_dark.svg",
        "Arizona Coyotes": "https://assets.nhle.com/logos/nhl/svg/ARI_dark.svg",
        "Boston Bruins": "https://assets.nhle.com/logos/nhl/svg/BOS_dark.svg",
        "Buffalo Sabres": "https://assets.nhle.com/logos/nhl/svg/BUF_dark.svg",
        "Calgary Flames": "https://assets.nhle.com/logos/nhl/svg/CGY_dark.svg",
        "Carolina Hurricanes": "https://assets.nhle.com/logos/nhl/svg/CAR_dark.svg",
        "Chicago Blackhawks": "https://assets.nhle.com/logos/nhl/svg/CHI_dark.svg",
        "Colorado Avalanche": "https://assets.nhle.com/logos/nhl/svg/COL_dark.svg",
        "Columbus Blue Jackets": "https://assets.nhle.com/logos/nhl/svg/CBJ_dark.svg",
        "Dallas Stars": "https://assets.nhle.com/logos/nhl/svg/DAL_dark.svg",
        "Detroit Red Wings": "https://assets.nhle.com/logos/nhl/svg/DET_dark.svg",
        "Edmonton Oilers": "https://assets.nhle.com/logos/nhl/svg/EDM_dark.svg",
        "Florida Panthers": "https://assets.nhle.com/logos/nhl/svg/FLA_dark.svg",
        "Los Angeles Kings": "https://assets.nhle.com/logos/nhl/svg/LAK_dark.svg",
        "Minnesota Wild": "https://assets.nhle.com/logos/nhl/svg/MIN_dark.svg",
        "Montréal Canadiens": "https://assets.nhle.com/logos/nhl/svg/MTL_dark.svg",
        "Montreal Canadiens": "https://assets.nhle.com/logos/nhl/svg/MTL_dark.svg",
        "Nashville Predators": "https://assets.nhle.com/logos/nhl/svg/NSH_dark.svg",
        "New Jersey Devils": "https://assets.nhle.com/logos/nhl/svg/NJD_dark.svg",
        "New York Islanders": "https://assets.nhle.com/logos/nhl/svg/NYI_dark.svg",
        "New York Rangers": "https://assets.nhle.com/logos/nhl/svg/NYR_dark.svg",
        "Ottawa Senators": "https://assets.nhle.com/logos/nhl/svg/OTT_dark.svg",
        "Philadelphia Flyers": "https://assets.nhle.com/logos/nhl/svg/PHI_dark.svg",
        "Pittsburgh Penguins": "https://assets.nhle.com/logos/nhl/svg/PIT_dark.svg",
        "San Jose Sharks": "https://assets.nhle.com/logos/nhl/svg/SJS_dark.svg",
        "Seattle Kraken": "https://assets.nhle.com/logos/nhl/svg/SEA_dark.svg",
        "St. Louis Blues": "https://assets.nhle.com/logos/nhl/svg/STL_dark.svg",
        "Tampa Bay Lightning": "https://assets.nhle.com/logos/nhl/svg/TBL_dark.svg",
        "Toronto Maple Leafs": "https://assets.nhle.com/logos/nhl/svg/TOR_dark.svg",
        "Utah Hockey Club": "https://assets.nhle.com/logos/nhl/svg/UTA_dark.svg",
        "Vancouver Canucks": "https://assets.nhle.com/logos/nhl/svg/VAN_dark.svg",
        "Vegas Golden Knights": "https://assets.nhle.com/logos/nhl/svg/VGK_dark.svg",
        "Washington Capitals": "https://assets.nhle.com/logos/nhl/svg/WSH_dark.svg",
        "Winnipeg Jets": "https://assets.nhle.com/logos/nhl/svg/WPG_dark.svg"
      };

      function openSetSearch() {
        const selectedSet = document.getElementById("setSelect").value;
        const selectedYear = document.getElementById("yearSelect").value;
        if (!selectedSet) {
          alert("Please select a set first.");
          return;
        }
        if (!selectedYear) {
          alert("Please select a set year first.");
          return;
        }
        const yearPrefix = selectedYear.split("-")[0];
        const query = yearPrefix + " " + selectedSet + " hockey hobby case";
        const url =
          "https://www.dacardworld.com/search/?Search=" +
          encodeURIComponent(query);
        window.open(url, "_blank");
      }

      function openSteelCitySearch() {
        const selectedSet = document.getElementById("setSelect").value;
        const selectedYear = document.getElementById("yearSelect").value;
        if (!selectedSet) {
          alert("Please select a set first.");
          return;
        }
        if (!selectedYear) {
          alert("Please select a set year first.");
          return;
        }
        const yearPrefix = selectedYear.split("-")[0];
        const query = yearPrefix + " " + selectedSet + " hockey hobby case";
        const url =
          "https://www.steelcitycollectibles.com/search?q=" +
          encodeURIComponent(query);
        window.open(url, "_blank");
      }

      function openTcdbSearch() {
        const selectedSet = document.getElementById("setSelect").value;
        const selectedYear = document.getElementById("yearSelect").value;
        if (!selectedSet) {
          alert("Please select a set first.");
          return;
        }
        if (!selectedYear) {
          alert("Please select a set year first.");
          return;
        }
        const yearPrefix = selectedYear.split("-")[0];
        const query = yearPrefix + " " + selectedSet;
        const url =
          "https://www.tcdb.com/Search.cfm?SearchCategory=Hockey&q=" +
          encodeURIComponent(query);
        window.open(url, "_blank");
      }
      
      function openHockeyChecklistsSearch() {
        const selectedSet = document.getElementById("setSelect").value;
        const selectedYear = document.getElementById("yearSelect").value;
        if (!selectedSet) {
          alert("Please select a set first.");
          return;
        }
        if (!selectedYear) {
          alert("Please select a set year first.");
          return;
        }
        const yearPrefix = selectedYear.split("-")[0];
        const query = yearPrefix + " " + selectedSet;
        const url =
          "https://hockeychecklists.com/checklist?search=" +
          encodeURIComponent(query);
        window.open(url, "_blank");
      }

      function openMidwestCardsSearch() {
        const selectedSet = document.getElementById("setSelect").value;
        const selectedYear = document.getElementById("yearSelect").value;
        if (!selectedSet) {
          alert("Please select a set first.");
          return;
        }
        if (!selectedYear) {
          alert("Please select a set year first.");
          return;
        }
        const yearPrefix = selectedYear.split("-")[0];
        const query = yearPrefix + " " + selectedSet + " hockey hobby case";
        const url =
          "https://www.midwestcards.com/search/?search_query=" +
          encodeURIComponent(query);
        window.open(url, "_blank");
      }

      function openBlowoutCardsSearch() {
        const selectedSet = document.getElementById("setSelect").value;
        const selectedYear = document.getElementById("yearSelect").value;
        if (!selectedSet) {
          alert("Please select a set first.");
          return;
        }
        if (!selectedYear) {
          alert("Please select a set year first.");
          return;
        }
        const yearPrefix = selectedYear.split("-")[0];
        const query = yearPrefix + " " + selectedSet + " hockey hobby case";
        const url =
          "https://www.blowoutcards.com/catalogsearch/result/?q=" +
          encodeURIComponent(query);
        window.open(url, "_blank");
      }

      function openOotbSearch() {
        const selectedSet = document.getElementById("setSelect").value;
        const selectedYear = document.getElementById("yearSelect").value;
        if (!selectedSet) {
          alert("Please select a set first.");
          return;
        }
        if (!selectedYear) {
          alert("Please select a set year first.");
          return;
        }
        const yearPrefix = selectedYear.split("-")[0];
        const query = yearPrefix + " " + selectedSet + " hockey hobby case";
        const url =
          "https://www.outoftheboxcards.com/?s=" +
          encodeURIComponent(query);
        window.open(url, "_blank");
      }
      
      function openTeamSearch(teamName) {
        const selectedYear = document.getElementById("yearSelect").value;
        const selectedSet = document.getElementById("setSelect").value;
        if (!selectedYear || !selectedSet) {
          alert("Please select both a year and a set.");
          return;
        }
        const firstYear = selectedYear.split("-")[0];
        const query =
          firstYear + " " + selectedSet + " " + teamName;
        const url =
          "https://www.ebay.com/sch/i.html?_nkw=" +
          encodeURIComponent(query) +
          "&_sop=16&rt=nc&LH_Sold=1&LH_Complete=1";
        window.open(url, "_blank");
      }
      
      function calculateProfit() {
        const selectedYear = document.getElementById("yearSelect").value;
        const selectedSetName = document.getElementById("setSelect").value;
        const casePrice = parseFloat(
          document.getElementById("casePrice").value
        );
        const markup = parsePercentage(
          document.getElementById("markup").value
        );
        const userDiscount = parsePercentage(
          document.getElementById("userDiscount").value
        );
        const blendedTax = parsePercentage(
          document.getElementById("blendedTax").value
        );
        const supplies = parseFloat(
          document.getElementById("supplies").value
        );

        if (
          !selectedYear ||
          !selectedSetName ||
          isNaN(casePrice) ||
          isNaN(markup) ||
          isNaN(userDiscount) ||
          isNaN(blendedTax) ||
          isNaN(supplies)
        ) {
          alert("Please fill in all fields with valid numbers.");
          return;
        }

        const setObj = setData.find(
          (set) => set.year === selectedYear && set.name === selectedSetName
        );
        if (!setObj) {
          alert("Selected set data not found.");
          return;
        }

        const teamData = setObj.cards || setObj.most_numbered_cards;
        let totalCards = 0;
        for (let team in teamData) {
          totalCards += teamData[team];
        }

        let rows = [];
        for (let team in teamData) {
          const count = teamData[team];
          const cost = (count / totalCards) * casePrice;
          const rawPrice = cost * (1 + markup);
          const price = rawPrice * (1 - userDiscount);
          const whatnotFees = cost * 0.08;
          const transactionFees =
            (price * (1 + blendedTax)) * 0.029 + 0.30;
          const profit = price - cost - whatnotFees - transactionFees - supplies;
          const distribution =
            ((count / totalCards) * 100).toFixed(1) + "%";

          rows.push({
            team: team,
            logo: teamLogos[team] || "",
            count: count,
            distribution: distribution,
            cost: cost,
            price: price,
            whatnotFees: whatnotFees,
            transactionFees: transactionFees,
            profit: profit,
          });
        }

        const totalProfit = rows.reduce(
          (sum, row) => sum + row.profit,
          0
        );
        const totalWhatnotsCut = rows.reduce(
          (sum, row) => sum + row.whatnotFees,
          0
        );
        const totalCostOfBusiness =
          rows.reduce(
            (sum, row) => sum + row.transactionFees,
            0
          ) + rows.length * supplies;

        document.querySelector(
          "#totalProfitBox .amount"
        ).textContent = "$" + totalProfit.toFixed(2);
        document.querySelector(
          "#whatnotsCutBox .amount"
        ).textContent = "$" + totalWhatnotsCut.toFixed(2);
        document.querySelector(
          "#costOfBusinessBox .amount"
        ).textContent = "$" + totalCostOfBusiness.toFixed(2);

        let resultsHtml = '<table id="resultsTable">';
        resultsHtml += "<thead><tr>";
        resultsHtml +=
          '<th data-sort="text" onclick="sortTable(0)">Team</th>';
        resultsHtml +=
          '<th data-sort="number" onclick="sortTable(1)">Numbered Cards</th>';
        resultsHtml +=
          '<th data-sort="number" onclick="sortTable(2)">Distribution</th>';
        resultsHtml +=
          '<th data-sort="number" onclick="sortTable(3)">Cost</th>';
        resultsHtml +=
          '<th data-sort="number" onclick="sortTable(4)">Price</th>';
        resultsHtml +=
          '<th data-sort="number" onclick="sortTable(5)">Whatnot Fees</th>';
        resultsHtml +=
          '<th data-sort="number" onclick="sortTable(6)">Transaction Fees</th>';
        resultsHtml +=
          '<th data-sort="number" onclick="sortTable(7)">Profit</th>';
        resultsHtml += "</tr></thead><tbody>";

        const tbodyHtml = renderRows(rows);
        resultsHtml += tbodyHtml + "</tbody></table>";
        document.getElementById("results").innerHTML = resultsHtml;

        if (rows.length > 0) {
          document.getElementById("teamPricesHeader").style.display =
            "block";
        } else {
          document.getElementById("teamPricesHeader").style.display =
            "none";
        }

        tableData = rows;

        const chartData = [
          totalProfit,
          totalWhatnotsCut,
          totalCostOfBusiness,
        ];
        const chartContainer = document.getElementById("chartContainer");
        if (chartData.every((val) => val === 0)) {
          chartContainer.style.display = "none";
        } else {
          chartContainer.style.display = "block";
        }

        if (pieChart) {
          pieChart.data.datasets[0].data = chartData;
          pieChart.update();
        } else {
          const ctx = document
            .getElementById("pieChart")
            .getContext("2d");
          pieChart = new Chart(ctx, {
            type: "pie",
            data: {
              labels: [
                "Breaker's Profit",
                "Whatnot's Cut",
                "Cost of Business",
              ],
              datasets: [
                {
                  data: chartData,
                  backgroundColor: [
                    "#2e7d32",
                    "#bfa600",
                    "#007bff",
                  ],
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "bottom",
                  labels: { color: "#e0e0e0" },
                },
              },
            },
          });
        }
      }

      function renderRows(arr) {
        let html = "";
        arr.forEach((row) => {
          // Highlight row if team is in highlightTeams
          let highlightClass = highlightTeams.has(row.team)
            ? "highlight"
            : "";
          html += `<tr class="${highlightClass}">`;
          html +=
            '<td><a href="#" onclick="openTeamSearch(\'' +
            row.team +
            '\')" style="color: inherit; text-decoration: none;">';
          html += row.logo
            ? `<img src="${row.logo}" alt="${row.team} logo" class="logo">`
            : "";
          html += row.team;
          html +=
            '<img src="resources/share_white.png" alt="Share" class="link-icon">';
          html +=
            '<img src="https://cdn4.iconfinder.com/data/icons/flat-brand-logo-2/512/ebay-1024.png" alt="eBay" class="link-icon ebay-icon">';
          html += "</a></td>";
          html += "<td>" + row.count + "</td>";
          html += "<td>" + row.distribution + "</td>";
          html += "<td>$" + row.cost.toFixed(2) + "</td>";
          html += "<td>$" + row.price.toFixed(2) + "</td>";
          html += "<td>$" + row.whatnotFees.toFixed(2) + "</td>";
          html += "<td>$" + row.transactionFees.toFixed(2) + "</td>";
          html += "<td>$" + row.profit.toFixed(2) + "</td>";
          html += "</tr>";
        });
        return html;
      }

      function sortTable(columnIndex) {
        if (!tableData) return;

        if (currentSortedColumn !== columnIndex) {
          sortDirections[columnIndex] = 1;
          currentSortedColumn = columnIndex;
        } else {
          sortDirections[columnIndex] *= -1;
        }
        const direction = sortDirections[columnIndex];

        tableData.sort((a, b) => {
          let aVal, bVal;
          if (columnIndex === 0) {
            aVal = a.team.toLowerCase();
            bVal = b.team.toLowerCase();
          } else if (columnIndex === 1) {
            aVal = Number(a.count);
            bVal = Number(b.count);
          } else if (columnIndex === 2) {
            aVal = parseFloat(a.distribution);
            bVal = parseFloat(b.distribution);
          } else if (columnIndex === 3) {
            aVal = Number(a.cost);
            bVal = Number(b.cost);
          } else if (columnIndex === 4) {
            aVal = Number(a.price);
            bVal = Number(b.price);
          } else if (columnIndex === 5) {
            aVal = Number(a.whatnotFees);
            bVal = Number(b.whatnotFees);
          } else if (columnIndex === 6) {
            aVal = Number(a.transactionFees);
            bVal = Number(b.transactionFees);
          } else if (columnIndex === 7) {
            aVal = Number(a.profit);
            bVal = Number(b.profit);
          }

          if (aVal < bVal) return -1 * direction;
          if (aVal > bVal) return 1 * direction;
          return 0;
        });

        const tbody = document
          .getElementById("resultsTable")
          .getElementsByTagName("tbody")[0];
        tbody.innerHTML = renderRows(tableData);
      }

      const summaryBoxes = document.querySelectorAll(".summary-box");
      summaryBoxes.forEach((box) => {
        box.addEventListener("click", function () {
          const toast = this.querySelector(".toast");
          toast.style.display =
            toast.style.display === "block" ? "none" : "block";
        });
      });

      document
        .getElementById("calcForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          calculateProfit();
        });

      // Load config.json on page load.
      window.addEventListener("load", function () {
        fetch("config.json")
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                "Network response was not ok: " + response.statusText
              );
            }
            return response.json();
          })
          .then((jsonData) => {
            if (!jsonData.sets) {
              alert('Invalid JSON format: missing "sets" property.');
              return;
            }
            setData = jsonData.sets;
            keyPlayersData = jsonData["Key Players"] || [];
            populateYearSelector();
            document
              .getElementById("setSelect")
              .addEventListener("change", updateCasePrice);
          })
          .catch((error) => {
            console.error("Error loading JSON:", error);
            alert("Error loading JSON file: " + error.message);
          });
      });
    </script>
  </body>
</html>
